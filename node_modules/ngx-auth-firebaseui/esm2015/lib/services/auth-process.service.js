import { __awaiter, __decorate, __param } from "tslib";
import { EventEmitter, forwardRef, Inject, Injectable } from '@angular/core';
import { AngularFireAuth } from '@angular/fire/auth';
import { firebase } from '@firebase/app';
import '@firebase/auth';
import { tap } from 'rxjs/operators';
import { Accounts } from '../enums';
import { FirestoreSyncService } from './firestore-sync.service';
import { MAT_SNACK_BAR_DEFAULT_OPTIONS, MatSnackBar, MatSnackBarConfig } from '@angular/material/snack-bar';
import { NgxAuthFirebaseUIConfigToken } from '../tokens';
import * as i0 from "@angular/core";
import * as i1 from "@angular/fire/auth";
import * as i2 from "../tokens/index";
import * as i3 from "@angular/material/snack-bar";
import * as i4 from "./firestore-sync.service";
export const facebookAuthProvider = new firebase.auth.FacebookAuthProvider();
export const googleAuthProvider = new firebase.auth.GoogleAuthProvider();
export const appleAuthProvider = new firebase.auth.OAuthProvider('apple.com');
export const twitterAuthProvider = new firebase.auth.TwitterAuthProvider();
export const githubAuthProvider = new firebase.auth.GithubAuthProvider();
export const microsoftAuthProvider = new firebase.auth.OAuthProvider('microsoft.com');
export const yahooAuthProvider = new firebase.auth.OAuthProvider('yahoo.com');
export var AuthProvider;
(function (AuthProvider) {
    AuthProvider["ALL"] = "all";
    AuthProvider["ANONYMOUS"] = "anonymous";
    AuthProvider["EmailAndPassword"] = "firebase";
    AuthProvider["Google"] = "google";
    AuthProvider["Apple"] = "Apple";
    AuthProvider["Facebook"] = "facebook";
    AuthProvider["Twitter"] = "twitter";
    AuthProvider["Github"] = "github";
    AuthProvider["Microsoft"] = "microsoft";
    AuthProvider["Yahoo"] = "yahoo";
    AuthProvider["PhoneNumber"] = "phoneNumber";
})(AuthProvider || (AuthProvider = {}));
let AuthProcessService = class AuthProcessService {
    constructor(afa, config, snackBar, fireStoreService, matSnackBarConfig) {
        this.afa = afa;
        this.config = config;
        this.snackBar = snackBar;
        this.fireStoreService = fireStoreService;
        this.matSnackBarConfig = matSnackBarConfig;
        this.onSuccessEmitter = new EventEmitter();
        this.onErrorEmitter = new EventEmitter();
    }
    listenToUserEvents() {
        this.user$ = this.afa.user.pipe(tap(user => {
            this.user = user;
        }));
    }
    /**
     * Reset the password of the ngx-auth-firebaseui-user via email
     *
     * @param email - the email to reset
     */
    resetPassword(email) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                console.log('Password reset email sent');
                return yield this.afa.sendPasswordResetEmail(email);
            }
            catch (error) {
                return this.notifyError(error);
            }
        });
    }
    /**
     * General sign in mechanism to authenticate the users with a firebase project
     * using a traditional way, via username and password or by using an authentication provider
     * like google, facebook, twitter and github
     *
     * @param provider - the provider to authenticate with (google, facebook, twitter, github)
     // tslint:disable-next-line:no-redundant-jsdoc
     * @param credentials
     */
    signInWith(provider, credentials) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                let signInResult;
                switch (provider) {
                    case AuthProvider.ANONYMOUS:
                        signInResult = (yield this.afa.signInAnonymously());
                        break;
                    case AuthProvider.EmailAndPassword:
                        signInResult = (yield this.afa.signInWithEmailAndPassword(credentials.email, credentials.password));
                        break;
                    case AuthProvider.Google:
                        signInResult = (yield this.afa.signInWithPopup(googleAuthProvider));
                        break;
                    case AuthProvider.Apple:
                        signInResult = (yield this.afa.signInWithPopup(appleAuthProvider));
                        break;
                    case AuthProvider.Facebook:
                        signInResult = (yield this.afa.signInWithPopup(facebookAuthProvider));
                        break;
                    case AuthProvider.Twitter:
                        signInResult = (yield this.afa.signInWithPopup(twitterAuthProvider));
                        break;
                    case AuthProvider.Github:
                        signInResult = (yield this.afa.signInWithPopup(githubAuthProvider));
                        break;
                    case AuthProvider.Microsoft:
                        signInResult = (yield this.afa.signInWithPopup(microsoftAuthProvider));
                        break;
                    case AuthProvider.Yahoo:
                        signInResult = (yield this.afa.signInWithPopup(yahooAuthProvider));
                        break;
                    case AuthProvider.PhoneNumber:
                        // coming soon - see feature/sms branch
                        break;
                    default:
                        throw new Error(`${AuthProvider[provider]} is not available as auth provider`);
                }
                yield this.handleSuccess(signInResult);
            }
            catch (err) {
                this.handleError(err);
            }
        });
    }
    /**
     * Sign up new users via email and password.
     * After that the ngx-auth-firebaseui-user should verify and confirm an email sent via the firebase
     *
     * @param displayName - the displayName if the new ngx-auth-firebaseui-user
     * @returns -
     */
    signUp(displayName, credentials) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const userCredential = yield this.afa.createUserWithEmailAndPassword(credentials.email, credentials.password);
                const user = userCredential.user;
                yield this.updateProfile(displayName, user.photoURL);
                if (this.config.enableFirestoreSync) {
                    yield this.fireStoreService
                        .getUserDocRefByUID(user.uid)
                        .set({
                        uid: user.uid,
                        displayName,
                        email: user.email,
                        photoURL: user.photoURL
                    });
                }
                if (this.config.enableEmailVerification) {
                    yield user.sendEmailVerification();
                }
                // Legacy fields
                this.emailConfirmationSent = true;
                this.emailToConfirm = credentials.email;
                yield this.handleSuccess(userCredential);
            }
            catch (err) {
                this.handleError(err);
            }
        });
    }
    sendNewVerificationEmail() {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.user) {
                return Promise.reject(new Error('No signed in user'));
            }
            return this.user.sendEmailVerification();
        });
    }
    signOut() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                yield this.afa.signOut();
            }
            catch (error) {
                this.notifyError(error);
            }
        });
    }
    /**
     * Update the profile (name + photo url) of the authenticated ngx-auth-firebaseui-user in the
     * firebase authentication feature (not in firestore)
     *
     * @param name - the new name of the authenticated ngx-auth-firebaseui-user
     * @param photoURL - the new photo url of the authenticated ngx-auth-firebaseui-user
     * @returns -
     */
    updateProfile(name, photoURL) {
        if (!photoURL) {
            return this.user.updateProfile({ displayName: name });
        }
        else {
            return this.user.updateProfile({ displayName: name, photoURL });
        }
    }
    parseUserInfo(user) {
        return {
            uid: user.uid,
            displayName: user.displayName,
            email: user.email,
            phoneNumber: user.phoneNumber,
            photoURL: user.photoURL,
            providerId: user.providerData.length > 0 ? user.providerData[0].providerId : null
        };
    }
    getUserPhotoUrl() {
        const user = this.user;
        if (!user) {
            return;
        }
        else if (user.photoURL) {
            return user.photoURL;
        }
        else if (user.emailVerified) {
            return this.getPhotoPath(Accounts.CHECK);
        }
        else if (user.isAnonymous) {
            return this.getPhotoPath(Accounts.OFF);
        }
        else {
            return this.getPhotoPath(Accounts.NONE);
        }
    }
    getPhotoPath(image) {
        return `assets/user/${image}.svg`;
    }
    signInWithPhoneNumber() {
        // todo: 3.1.18
    }
    handleSuccess(userCredential) {
        return __awaiter(this, void 0, void 0, function* () {
            this.onSuccessEmitter.next(userCredential.user);
            if (this.config.enableFirestoreSync) {
                try {
                    yield this.fireStoreService.updateUserData(this.parseUserInfo(userCredential.user));
                }
                catch (e) {
                    console.error(`Error occurred while updating user data with firestore: ${e}`);
                }
            }
            if (this.config.toastMessageOnAuthSuccess) {
                const fallbackMessage = `Hello ${userCredential.user.displayName ? userCredential.user.displayName : ''}!`;
                this.showToast(this.messageOnAuthSuccess || fallbackMessage);
            }
        });
    }
    handleError(error) {
        this.notifyError(error);
        console.error(error);
    }
    // Refresh user info. Can be useful for instance to get latest status regarding email verification.
    reloadUserInfo() {
        return this.user.reload();
    }
    // Search for an error message.
    // Consumers of this library are given the possibility to provide a
    // function in case they want to instrument message based on error properties.
    getMessageOnAuthError(error) {
        // tslint:disable-next-line:no-bitwise
        return error.toString() || 'Sorry, something went wrong. Please retry later.';
    }
    // Show a toast using current snackbar config. If message is empty, no toast is displayed allowing to opt-out when needed.
    // Default MatSnackBarConfig has no duration, meaning it stays visible forever.
    // If that's the case, an action button is added to allow the end-user to dismiss the toast.
    showToast(message) {
        if (message) {
            this.snackBar.open(message, this.matSnackBarConfig.duration ? null : 'OK');
        }
    }
    showErrorToast(error) {
        if (this.config.toastMessageOnAuthError) {
            this.showToast(this.getMessageOnAuthError(error));
        }
    }
    notifyError(error) {
        this.onErrorEmitter.emit(error);
        this.showErrorToast(error);
    }
};
AuthProcessService.ctorParameters = () => [
    { type: AngularFireAuth },
    { type: undefined, decorators: [{ type: Inject, args: [forwardRef(() => NgxAuthFirebaseUIConfigToken),] }] },
    { type: MatSnackBar },
    { type: FirestoreSyncService },
    { type: MatSnackBarConfig, decorators: [{ type: Inject, args: [MAT_SNACK_BAR_DEFAULT_OPTIONS,] }] }
];
AuthProcessService.ɵprov = i0.ɵɵdefineInjectable({ factory: function AuthProcessService_Factory() { return new AuthProcessService(i0.ɵɵinject(i1.AngularFireAuth), i0.ɵɵinject(i2.NgxAuthFirebaseUIConfigToken), i0.ɵɵinject(i3.MatSnackBar), i0.ɵɵinject(i4.FirestoreSyncService), i0.ɵɵinject(i3.MAT_SNACK_BAR_DEFAULT_OPTIONS)); }, token: AuthProcessService, providedIn: "root" });
AuthProcessService = __decorate([
    Injectable({
        providedIn: 'root'
    }),
    __param(1, Inject(forwardRef(() => NgxAuthFirebaseUIConfigToken))),
    __param(4, Inject(MAT_SNACK_BAR_DEFAULT_OPTIONS))
], AuthProcessService);
export { AuthProcessService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC1wcm9jZXNzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtYXV0aC1maXJlYmFzZXVpLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL2F1dGgtcHJvY2Vzcy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUMsWUFBWSxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQzNFLE9BQU8sRUFBQyxlQUFlLEVBQUMsTUFBTSxvQkFBb0IsQ0FBQztBQUNuRCxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ3ZDLE9BQU8sZ0JBQWdCLENBQUM7QUFHeEIsT0FBTyxFQUFDLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ25DLE9BQU8sRUFBQyxRQUFRLEVBQUMsTUFBTSxVQUFVLENBQUM7QUFDbEMsT0FBTyxFQUFDLG9CQUFvQixFQUFDLE1BQU0sMEJBQTBCLENBQUM7QUFDOUQsT0FBTyxFQUFDLDZCQUE2QixFQUFFLFdBQVcsRUFBRSxpQkFBaUIsRUFBQyxNQUFNLDZCQUE2QixDQUFDO0FBRTFHLE9BQU8sRUFBQyw0QkFBNEIsRUFBQyxNQUFNLFdBQVcsQ0FBQzs7Ozs7O0FBTXZELE1BQU0sQ0FBQyxNQUFNLG9CQUFvQixHQUFHLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO0FBQzdFLE1BQU0sQ0FBQyxNQUFNLGtCQUFrQixHQUFHLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO0FBQ3pFLE1BQU0sQ0FBQyxNQUFNLGlCQUFpQixHQUFHLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDOUUsTUFBTSxDQUFDLE1BQU0sbUJBQW1CLEdBQUcsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7QUFDM0UsTUFB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Q0FBQztRQUNoQyxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQzdCLENBQUM7Q0FFRixDQUFBOztZQTNQZSxlQUFlOzRDQUMxQixNQUFNLFNBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLDRCQUE0QixDQUFDO1lBQ3BDLFdBQVc7WUFDSCxvQkFBb0I7WUFDb0IsaUJBQWlCLHVCQUFsRixNQUFNLFNBQUMsNkJBQTZCOzs7QUF2QjVCLGtCQUFrQjtJQUg5QixVQUFVLENBQUM7UUFDVixVQUFVLEVBQUUsTUFBTTtLQUNuQixDQUFDO0lBcUJHLFdBQUEsTUFBTSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDLENBQUE7SUFHdEQsV0FBQSxNQUFNLENBQUMsNkJBQTZCLENBQUMsQ0FBQTtHQXZCN0Isa0JBQWtCLENBOFE5QjtTQTlRWSxrQkFBa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0V2ZW50RW1pdHRlciwgZm9yd2FyZFJlZiwgSW5qZWN0LCBJbmplY3RhYmxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7QW5ndWxhckZpcmVBdXRofSBmcm9tICdAYW5ndWxhci9maXJlL2F1dGgnO1xuaW1wb3J0IHtmaXJlYmFzZX0gZnJvbSAnQGZpcmViYXNlL2FwcCc7XG5pbXBvcnQgJ0BmaXJlYmFzZS9hdXRoJztcbmltcG9ydCB7VXNlciwgVXNlckluZm99IGZyb20gJ2ZpcmViYXNlL2FwcCc7XG5pbXBvcnQge09ic2VydmFibGV9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHt0YXB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7QWNjb3VudHN9IGZyb20gJy4uL2VudW1zJztcbmltcG9ydCB7RmlyZXN0b3JlU3luY1NlcnZpY2V9IGZyb20gJy4vZmlyZXN0b3JlLXN5bmMuc2VydmljZSc7XG5pbXBvcnQge01BVF9TTkFDS19CQVJfREVGQVVMVF9PUFRJT05TLCBNYXRTbmFja0JhciwgTWF0U25hY2tCYXJDb25maWd9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL3NuYWNrLWJhcic7XG5pbXBvcnQge0lDcmVkZW50aWFscywgSVNpZ25JblByb2Nlc3MsIElTaWduVXBQcm9jZXNzLCBOZ3hBdXRoRmlyZWJhc2VVSUNvbmZpZ30gZnJvbSAnLi4vaW50ZXJmYWNlcyc7XG5pbXBvcnQge05neEF1dGhGaXJlYmFzZVVJQ29uZmlnVG9rZW59IGZyb20gJy4uL3Rva2Vucyc7XG5cbi8vIGltcG9ydCBVc2VyID0gZmlyZWJhc2UuVXNlcjtcblxuaW1wb3J0IFVzZXJDcmVkZW50aWFsID0gZmlyZWJhc2UuYXV0aC5Vc2VyQ3JlZGVudGlhbDtcblxuZXhwb3J0IGNvbnN0IGZhY2Vib29rQXV0aFByb3ZpZGVyID0gbmV3IGZpcmViYXNlLmF1dGguRmFjZWJvb2tBdXRoUHJvdmlkZXIoKTtcbmV4cG9ydCBjb25zdCBnb29nbGVBdXRoUHJvdmlkZXIgPSBuZXcgZmlyZWJhc2UuYXV0aC5Hb29nbGVBdXRoUHJvdmlkZXIoKTtcbmV4cG9ydCBjb25zdCBhcHBsZUF1dGhQcm92aWRlciA9IG5ldyBmaXJlYmFzZS5hdXRoLk9BdXRoUHJvdmlkZXIoJ2FwcGxlLmNvbScpO1xuZXhwb3J0IGNvbnN0IHR3aXR0ZXJBdXRoUHJvdmlkZXIgPSBuZXcgZmlyZWJhc2UuYXV0aC5Ud2l0dGVyQXV0aFByb3ZpZGVyKCk7XG5leHBvcnQgY29uc3QgZ2l0aHViQXV0aFByb3ZpZGVyID0gbmV3IGZpcmViYXNlLmF1dGguR2l0aHViQXV0aFByb3ZpZGVyKCk7XG5leHBvcnQgY29uc3QgbWljcm9zb2Z0QXV0aFByb3ZpZGVyID0gbmV3IGZpcmViYXNlLmF1dGguT0F1dGhQcm92aWRlcignbWljcm9zb2Z0LmNvbScpO1xuZXhwb3J0IGNvbnN0IHlhaG9vQXV0aFByb3ZpZGVyID0gbmV3IGZpcmViYXNlLmF1dGguT0F1dGhQcm92aWRlcigneWFob28uY29tJyk7XG5cbmV4cG9ydCBlbnVtIEF1dGhQcm92aWRlciB7XG4gIEFMTCA9ICdhbGwnLFxuICBBTk9OWU1PVVMgPSAnYW5vbnltb3VzJyxcbiAgRW1haWxBbmRQYXNzd29yZCA9ICdmaXJlYmFzZScsXG4gIEdvb2dsZSA9ICdnb29nbGUnLFxuICBBcHBsZSA9ICdBcHBsZScsXG4gIEZhY2Vib29rID0gJ2ZhY2Vib29rJyxcbiAgVHdpdHRlciA9ICd0d2l0dGVyJyxcbiAgR2l0aHViID0gJ2dpdGh1YicsXG4gIE1pY3Jvc29mdCA9ICdtaWNyb3NvZnQnLFxuICBZYWhvbyA9ICd5YWhvbycsXG4gIFBob25lTnVtYmVyID0gJ3Bob25lTnVtYmVyJ1xufVxuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBBdXRoUHJvY2Vzc1NlcnZpY2UgaW1wbGVtZW50cyBJU2lnbkluUHJvY2VzcywgSVNpZ25VcFByb2Nlc3Mge1xuICBvblN1Y2Nlc3NFbWl0dGVyOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICBvbkVycm9yRW1pdHRlcjogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICAvLyBVc2VmdWwgdG8ga25vdyBhdWJvdXQgYXV0aCBzdGF0ZSBldmVuIGJldHdlZW4gcmVsb2Fkcy5cbiAgLy8gUmVwbGFjZSBlbWFpbENvbmZpcm1hdGlvblNlbnQgYW5kIGVtYWlsVG9Db25maXJtLlxuICB1c2VyJDogT2JzZXJ2YWJsZTxVc2VyPjtcbiAgdXNlcjogVXNlcjtcblxuICBtZXNzYWdlT25BdXRoU3VjY2Vzczogc3RyaW5nO1xuICBtZXNzYWdlT25BdXRoRXJyb3I6IHN0cmluZztcblxuICAvLyBMZWdhY3kgZmllbGQgdGhhdCBpcyBzZXR0ZWQgdG8gdHJ1ZSBhZnRlciBzaWduIHVwLlxuICAvLyBWYWx1ZSBpcyBsb3N0IGluIGNhc2Ugb2YgcmVsb2FkLiBUaGUgaWRlYSBoZXJlIGlzIHRvIGtub3cgaWYgd2UganVzdCBzZW50IGEgdmVyaWZpY2F0aW9uIGVtYWlsLlxuICBlbWFpbENvbmZpcm1hdGlvblNlbnQ6IGJvb2xlYW47XG4gIC8vIExlZmFjeSBmaWxlZCB0aGF0IGNvbnRhaW4gdGhlIG1haWwgdG8gY29uZmlybS4gU2FtZSBsaWZlY3lsZSB0aGFuIGVtYWlsQ29uZmlybWF0aW9uU2VudC5cbiAgZW1haWxUb0NvbmZpcm06IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgYWZhOiBBbmd1bGFyRmlyZUF1dGgsXG4gICAgQEluamVjdChmb3J3YXJkUmVmKCgpID0+IE5neEF1dGhGaXJlYmFzZVVJQ29uZmlnVG9rZW4pKSBwdWJsaWMgY29uZmlnOiBOZ3hBdXRoRmlyZWJhc2VVSUNvbmZpZyxcbiAgICBwcml2YXRlIHNuYWNrQmFyOiBNYXRTbmFja0JhcixcbiAgICBwcml2YXRlIGZpcmVTdG9yZVNlcnZpY2U6IEZpcmVzdG9yZVN5bmNTZXJ2aWNlLFxuICAgIEBJbmplY3QoTUFUX1NOQUNLX0JBUl9ERUZBVUxUX09QVElPTlMpIHByaXZhdGUgbWF0U25hY2tCYXJDb25maWc6IE1hdFNuYWNrQmFyQ29uZmlnXG4gICkge1xuICB9XG5cbiAgbGlzdGVuVG9Vc2VyRXZlbnRzKCkge1xuICAgIHRoaXMudXNlciQgPSB0aGlzLmFmYS51c2VyLnBpcGUoXG4gICAgICB0YXAodXNlciA9PiB7XG4gICAgICAgIHRoaXMudXNlciA9IHVzZXI7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUmVzZXQgdGhlIHBhc3N3b3JkIG9mIHRoZSBuZ3gtYXV0aC1maXJlYmFzZXVpLXVzZXIgdmlhIGVtYWlsXG4gICAqXG4gICAqIEBwYXJhbSBlbWFpbCAtIHRoZSBlbWFpbCB0byByZXNldFxuICAgKi9cbiAgcHVibGljIGFzeW5jIHJlc2V0UGFzc3dvcmQoZW1haWw6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zb2xlLmxvZygnUGFzc3dvcmQgcmVzZXQgZW1haWwgc2VudCcpO1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuYWZhLnNlbmRQYXNzd29yZFJlc2V0RW1haWwoZW1haWwpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4gdGhpcy5ub3RpZnlFcnJvcihlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdlbmVyYWwgc2lnbiBpbiBtZWNoYW5pc20gdG8gYXV0aGVudGljYXRlIHRoZSB1c2VycyB3aXRoIGEgZmlyZWJhc2UgcHJvamVjdFxuICAgKiB1c2luZyBhIHRyYWRpdGlvbmFsIHdheSwgdmlhIHVzZXJuYW1lIGFuZCBwYXNzd29yZCBvciBieSB1c2luZyBhbiBhdXRoZW50aWNhdGlvbiBwcm92aWRlclxuICAgKiBsaWtlIGdvb2dsZSwgZmFjZWJvb2ssIHR3aXR0ZXIgYW5kIGdpdGh1YlxuICAgKlxuICAgKiBAcGFyYW0gcHJvdmlkZXIgLSB0aGUgcHJvdmlkZXIgdG8gYXV0aGVudGljYXRlIHdpdGggKGdvb2dsZSwgZmFjZWJvb2ssIHR3aXR0ZXIsIGdpdGh1YilcbiAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1yZWR1bmRhbnQtanNkb2NcbiAgICogQHBhcmFtIGNyZWRlbnRpYWxzXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgc2lnbkluV2l0aChwcm92aWRlcjogQXV0aFByb3ZpZGVyLCBjcmVkZW50aWFscz86IElDcmVkZW50aWFscykge1xuICAgIHRyeSB7XG4gICAgICBsZXQgc2lnbkluUmVzdWx0OiBVc2VyQ3JlZGVudGlhbCB8IGFueTtcblxuICAgICAgc3dpdGNoIChwcm92aWRlcikge1xuICAgICAgICBjYXNlIEF1dGhQcm92aWRlci5BTk9OWU1PVVM6XG4gICAgICAgICAgc2lnbkluUmVzdWx0ID0gYXdhaXQgdGhpcy5hZmEuc2lnbkluQW5vbnltb3VzbHkoKSBhcyBVc2VyQ3JlZGVudGlhbDtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIEF1dGhQcm92aWRlci5FbWFpbEFuZFBhc3N3b3JkOlxuICAgICAgICAgIHNpZ25JblJlc3VsdCA9IGF3YWl0IHRoaXMuYWZhLnNpZ25JbldpdGhFbWFpbEFuZFBhc3N3b3JkKGNyZWRlbnRpYWxzLmVtYWlsLCBjcmVkZW50aWFscy5wYXNzd29yZCkgYXMgVXNlckNyZWRlbnRpYWw7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSBBdXRoUHJvdmlkZXIuR29vZ2xlOlxuICAgICAgICAgIHNpZ25JblJlc3VsdCA9IGF3YWl0IHRoaXMuYWZhLnNpZ25JbldpdGhQb3B1cChnb29nbGVBdXRoUHJvdmlkZXIpIGFzIFVzZXJDcmVkZW50aWFsO1xuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgQXV0aFByb3ZpZGVyLkFwcGxlOlxuICAgICAgICAgIHNpZ25JblJlc3VsdCA9IGF3YWl0IHRoaXMuYWZhLnNpZ25JbldpdGhQb3B1cChhcHBsZUF1dGhQcm92aWRlcikgYXMgVXNlckNyZWRlbnRpYWw7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSBBdXRoUHJvdmlkZXIuRmFjZWJvb2s6XG4gICAgICAgICAgc2lnbkluUmVzdWx0ID0gYXdhaXQgdGhpcy5hZmEuc2lnbkluV2l0aFBvcHVwKGZhY2Vib29rQXV0aFByb3ZpZGVyKSBhcyBVc2VyQ3JlZGVudGlhbDtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIEF1dGhQcm92aWRlci5Ud2l0dGVyOlxuICAgICAgICAgIHNpZ25JblJlc3VsdCA9IGF3YWl0IHRoaXMuYWZhLnNpZ25JbldpdGhQb3B1cCh0d2l0dGVyQXV0aFByb3ZpZGVyKSBhcyBVc2VyQ3JlZGVudGlhbDtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIEF1dGhQcm92aWRlci5HaXRodWI6XG4gICAgICAgICAgc2lnbkluUmVzdWx0ID0gYXdhaXQgdGhpcy5hZmEuc2lnbkluV2l0aFBvcHVwKGdpdGh1YkF1dGhQcm92aWRlcikgYXMgVXNlckNyZWRlbnRpYWw7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSBBdXRoUHJvdmlkZXIuTWljcm9zb2Z0OlxuICAgICAgICAgIHNpZ25JblJlc3VsdCA9IGF3YWl0IHRoaXMuYWZhLnNpZ25JbldpdGhQb3B1cChtaWNyb3NvZnRBdXRoUHJvdmlkZXIpIGFzIFVzZXJDcmVkZW50aWFsO1xuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgQXV0aFByb3ZpZGVyLllhaG9vOlxuICAgICAgICAgIHNpZ25JblJlc3VsdCA9IGF3YWl0IHRoaXMuYWZhLnNpZ25JbldpdGhQb3B1cCh5YWhvb0F1dGhQcm92aWRlcikgYXMgVXNlckNyZWRlbnRpYWw7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSBBdXRoUHJvdmlkZXIuUGhvbmVOdW1iZXI6XG4gICAgICAgICAgLy8gY29taW5nIHNvb24gLSBzZWUgZmVhdHVyZS9zbXMgYnJhbmNoXG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7QXV0aFByb3ZpZGVyW3Byb3ZpZGVyXX0gaXMgbm90IGF2YWlsYWJsZSBhcyBhdXRoIHByb3ZpZGVyYCk7XG4gICAgICB9XG4gICAgICBhd2FpdCB0aGlzLmhhbmRsZVN1Y2Nlc3Moc2lnbkluUmVzdWx0KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRoaXMuaGFuZGxlRXJyb3IoZXJyKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2lnbiB1cCBuZXcgdXNlcnMgdmlhIGVtYWlsIGFuZCBwYXNzd29yZC5cbiAgICogQWZ0ZXIgdGhhdCB0aGUgbmd4LWF1dGgtZmlyZWJhc2V1aS11c2VyIHNob3VsZCB2ZXJpZnkgYW5kIGNvbmZpcm0gYW4gZW1haWwgc2VudCB2aWEgdGhlIGZpcmViYXNlXG4gICAqXG4gICAqIEBwYXJhbSBkaXNwbGF5TmFtZSAtIHRoZSBkaXNwbGF5TmFtZSBpZiB0aGUgbmV3IG5neC1hdXRoLWZpcmViYXNldWktdXNlclxuICAgKiBAcmV0dXJucyAtXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgc2lnblVwKGRpc3BsYXlOYW1lOiBzdHJpbmcsIGNyZWRlbnRpYWxzOiBJQ3JlZGVudGlhbHMpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdXNlckNyZWRlbnRpYWw6IFVzZXJDcmVkZW50aWFsID0gYXdhaXQgdGhpcy5hZmEuY3JlYXRlVXNlcldpdGhFbWFpbEFuZFBhc3N3b3JkKGNyZWRlbnRpYWxzLmVtYWlsLCBjcmVkZW50aWFscy5wYXNzd29yZCk7XG4gICAgICBjb25zdCB1c2VyID0gdXNlckNyZWRlbnRpYWwudXNlcjtcbiAgICAgIGF3YWl0IHRoaXMudXBkYXRlUHJvZmlsZShkaXNwbGF5TmFtZSwgdXNlci5waG90b1VSTCk7XG5cbiAgICAgIGlmICh0aGlzLmNvbmZpZy5lbmFibGVGaXJlc3RvcmVTeW5jKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuZmlyZVN0b3JlU2VydmljZVxuICAgICAgICAgIC5nZXRVc2VyRG9jUmVmQnlVSUQodXNlci51aWQpXG4gICAgICAgICAgLnNldCh7XG4gICAgICAgICAgICB1aWQ6IHVzZXIudWlkLFxuICAgICAgICAgICAgZGlzcGxheU5hbWUsXG4gICAgICAgICAgICBlbWFpbDogdXNlci5lbWFpbCxcbiAgICAgICAgICAgIHBob3RvVVJMOiB1c2VyLnBob3RvVVJMXG4gICAgICAgICAgfSBhcyBVc2VyKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHRoaXMuY29uZmlnLmVuYWJsZUVtYWlsVmVyaWZpY2F0aW9uKSB7XG4gICAgICAgIGF3YWl0IHVzZXIuc2VuZEVtYWlsVmVyaWZpY2F0aW9uKCk7XG4gICAgICB9XG5cbiAgICAgIC8vIExlZ2FjeSBmaWVsZHNcbiAgICAgIHRoaXMuZW1haWxDb25maXJtYXRpb25TZW50ID0gdHJ1ZTtcbiAgICAgIHRoaXMuZW1haWxUb0NvbmZpcm0gPSBjcmVkZW50aWFscy5lbWFpbDtcblxuICAgICAgYXdhaXQgdGhpcy5oYW5kbGVTdWNjZXNzKHVzZXJDcmVkZW50aWFsKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRoaXMuaGFuZGxlRXJyb3IoZXJyKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzZW5kTmV3VmVyaWZpY2F0aW9uRW1haWwoKSB7XG4gICAgaWYgKCF0aGlzLnVzZXIpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ05vIHNpZ25lZCBpbiB1c2VyJykpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy51c2VyLnNlbmRFbWFpbFZlcmlmaWNhdGlvbigpO1xuICB9XG5cbiAgYXN5bmMgc2lnbk91dCgpIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5hZmEuc2lnbk91dCgpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLm5vdGlmeUVycm9yKGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIHRoZSBwcm9maWxlIChuYW1lICsgcGhvdG8gdXJsKSBvZiB0aGUgYXV0aGVudGljYXRlZCBuZ3gtYXV0aC1maXJlYmFzZXVpLXVzZXIgaW4gdGhlXG4gICAqIGZpcmViYXNlIGF1dGhlbnRpY2F0aW9uIGZlYXR1cmUgKG5vdCBpbiBmaXJlc3RvcmUpXG4gICAqXG4gICAqIEBwYXJhbSBuYW1lIC0gdGhlIG5ldyBuYW1lIG9mIHRoZSBhdXRoZW50aWNhdGVkIG5neC1hdXRoLWZpcmViYXNldWktdXNlclxuICAgKiBAcGFyYW0gcGhvdG9VUkwgLSB0aGUgbmV3IHBob3RvIHVybCBvZiB0aGUgYXV0aGVudGljYXRlZCBuZ3gtYXV0aC1maXJlYmFzZXVpLXVzZXJcbiAgICogQHJldHVybnMgLVxuICAgKi9cbiAgcHVibGljIHVwZGF0ZVByb2ZpbGUobmFtZTogc3RyaW5nLCBwaG90b1VSTDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCFwaG90b1VSTCkge1xuICAgICAgcmV0dXJuIHRoaXMudXNlci51cGRhdGVQcm9maWxlKHtkaXNwbGF5TmFtZTogbmFtZX0pO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy51c2VyLnVwZGF0ZVByb2ZpbGUoe2Rpc3BsYXlOYW1lOiBuYW1lLCBwaG90b1VSTH0pO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBwYXJzZVVzZXJJbmZvKHVzZXI6IFVzZXIpOiBVc2VySW5mbyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHVpZDogdXNlci51aWQsXG4gICAgICBkaXNwbGF5TmFtZTogdXNlci5kaXNwbGF5TmFtZSxcbiAgICAgIGVtYWlsOiB1c2VyLmVtYWlsLFxuICAgICAgcGhvbmVOdW1iZXI6IHVzZXIucGhvbmVOdW1iZXIsXG4gICAgICBwaG90b1VSTDogdXNlci5waG90b1VSTCxcbiAgICAgIHByb3ZpZGVySWQ6IHVzZXIucHJvdmlkZXJEYXRhLmxlbmd0aCA+IDAgPyB1c2VyLnByb3ZpZGVyRGF0YVswXS5wcm92aWRlcklkIDogbnVsbFxuICAgIH07XG4gIH1cblxuICBwdWJsaWMgZ2V0VXNlclBob3RvVXJsKCk6IHN0cmluZyB7XG5cbiAgICBjb25zdCB1c2VyOiBmaXJlYmFzZS5Vc2VyIHwgbnVsbCA9IHRoaXMudXNlcjtcblxuICAgIGlmICghdXNlcikge1xuICAgICAgcmV0dXJuO1xuICAgIH0gZWxzZSBpZiAodXNlci5waG90b1VSTCkge1xuICAgICAgcmV0dXJuIHVzZXIucGhvdG9VUkw7XG4gICAgfSBlbHNlIGlmICh1c2VyLmVtYWlsVmVyaWZpZWQpIHtcbiAgICAgIHJldHVybiB0aGlzLmdldFBob3RvUGF0aChBY2NvdW50cy5DSEVDSyk7XG4gICAgfSBlbHNlIGlmICh1c2VyLmlzQW5vbnltb3VzKSB7XG4gICAgICByZXR1cm4gdGhpcy5nZXRQaG90b1BhdGgoQWNjb3VudHMuT0ZGKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0UGhvdG9QYXRoKEFjY291bnRzLk5PTkUpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXRQaG90b1BhdGgoaW1hZ2U6IHN0cmluZykge1xuICAgIHJldHVybiBgYXNzZXRzL3VzZXIvJHtpbWFnZX0uc3ZnYDtcbiAgfVxuXG4gIHB1YmxpYyBzaWduSW5XaXRoUGhvbmVOdW1iZXIoKSB7XG4gICAgLy8gdG9kbzogMy4xLjE4XG4gIH1cblxuICBhc3luYyBoYW5kbGVTdWNjZXNzKHVzZXJDcmVkZW50aWFsOiBVc2VyQ3JlZGVudGlhbCkge1xuICAgIHRoaXMub25TdWNjZXNzRW1pdHRlci5uZXh0KHVzZXJDcmVkZW50aWFsLnVzZXIpO1xuICAgIGlmICh0aGlzLmNvbmZpZy5lbmFibGVGaXJlc3RvcmVTeW5jKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLmZpcmVTdG9yZVNlcnZpY2UudXBkYXRlVXNlckRhdGEodGhpcy5wYXJzZVVzZXJJbmZvKHVzZXJDcmVkZW50aWFsLnVzZXIpKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihgRXJyb3Igb2NjdXJyZWQgd2hpbGUgdXBkYXRpbmcgdXNlciBkYXRhIHdpdGggZmlyZXN0b3JlOiAke2V9YCk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLmNvbmZpZy50b2FzdE1lc3NhZ2VPbkF1dGhTdWNjZXNzKSB7XG4gICAgICBjb25zdCBmYWxsYmFja01lc3NhZ2UgPSBgSGVsbG8gJHt1c2VyQ3JlZGVudGlhbC51c2VyLmRpc3BsYXlOYW1lID8gdXNlckNyZWRlbnRpYWwudXNlci5kaXNwbGF5TmFtZSA6ICcnfSFgO1xuICAgICAgdGhpcy5zaG93VG9hc3QodGhpcy5tZXNzYWdlT25BdXRoU3VjY2VzcyB8fCBmYWxsYmFja01lc3NhZ2UpO1xuICAgIH1cbiAgfVxuXG4gIGhhbmRsZUVycm9yKGVycm9yOiBhbnkpIHtcbiAgICB0aGlzLm5vdGlmeUVycm9yKGVycm9yKTtcbiAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgfVxuXG4gIC8vIFJlZnJlc2ggdXNlciBpbmZvLiBDYW4gYmUgdXNlZnVsIGZvciBpbnN0YW5jZSB0byBnZXQgbGF0ZXN0IHN0YXR1cyByZWdhcmRpbmcgZW1haWwgdmVyaWZpY2F0aW9uLlxuICByZWxvYWRVc2VySW5mbygpIHtcbiAgICByZXR1cm4gdGhpcy51c2VyLnJlbG9hZCgpO1xuICB9XG5cbiAgLy8gU2VhcmNoIGZvciBhbiBlcnJvciBtZXNzYWdlLlxuICAvLyBDb25zdW1lcnMgb2YgdGhpcyBsaWJyYXJ5IGFyZSBnaXZlbiB0aGUgcG9zc2liaWxpdHkgdG8gcHJvdmlkZSBhXG4gIC8vIGZ1bmN0aW9uIGluIGNhc2UgdGhleSB3YW50IHRvIGluc3RydW1lbnQgbWVzc2FnZSBiYXNlZCBvbiBlcnJvciBwcm9wZXJ0aWVzLlxuICBnZXRNZXNzYWdlT25BdXRoRXJyb3IoZXJyb3I6IGFueSkge1xuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1iaXR3aXNlXG4gICAgcmV0dXJuIGVycm9yLnRvU3RyaW5nKCkgfHwgJ1NvcnJ5LCBzb21ldGhpbmcgd2VudCB3cm9uZy4gUGxlYXNlIHJldHJ5IGxhdGVyLic7XG4gIH1cblxuICAvLyBTaG93IGEgdG9hc3QgdXNpbmcgY3VycmVudCBzbmFja2JhciBjb25maWcuIElmIG1lc3NhZ2UgaXMgZW1wdHksIG5vIHRvYXN0IGlzIGRpc3BsYXllZCBhbGxvd2luZyB0byBvcHQtb3V0IHdoZW4gbmVlZGVkLlxuICAvLyBEZWZhdWx0IE1hdFNuYWNrQmFyQ29uZmlnIGhhcyBubyBkdXJhdGlvbiwgbWVhbmluZyBpdCBzdGF5cyB2aXNpYmxlIGZvcmV2ZXIuXG4gIC8vIElmIHRoYXQncyB0aGUgY2FzZSwgYW4gYWN0aW9uIGJ1dHRvbiBpcyBhZGRlZCB0byBhbGxvdyB0aGUgZW5kLXVzZXIgdG8gZGlzbWlzcyB0aGUgdG9hc3QuXG4gIHNob3dUb2FzdChtZXNzYWdlOiBzdHJpbmcpIHtcbiAgICBpZiAobWVzc2FnZSkge1xuICAgICAgdGhpcy5zbmFja0Jhci5vcGVuKG1lc3NhZ2UsIHRoaXMubWF0U25hY2tCYXJDb25maWcuZHVyYXRpb24gPyBudWxsIDogJ09LJyk7XG4gICAgfVxuICB9XG5cbiAgc2hvd0Vycm9yVG9hc3QoZXJyb3I6IGFueSkge1xuICAgIGlmICh0aGlzLmNvbmZpZy50b2FzdE1lc3NhZ2VPbkF1dGhFcnJvcikge1xuICAgICAgdGhpcy5zaG93VG9hc3QodGhpcy5nZXRNZXNzYWdlT25BdXRoRXJyb3IoZXJyb3IpKTtcbiAgICB9XG4gIH1cblxuICBub3RpZnlFcnJvcihlcnJvcjogYW55KSB7XG4gICAgdGhpcy5vbkVycm9yRW1pdHRlci5lbWl0KGVycm9yKTtcbiAgICB0aGlzLnNob3dFcnJvclRvYXN0KGVycm9yKTtcbiAgfVxuXG59XG4iXX0=