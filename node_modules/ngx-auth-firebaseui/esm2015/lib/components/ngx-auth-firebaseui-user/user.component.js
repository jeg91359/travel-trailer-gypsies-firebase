import { __awaiter, __decorate, __param } from "tslib";
import { Component, EventEmitter, forwardRef, Inject, Input, Output } from '@angular/core';
import { AngularFireAuth } from '@angular/fire/auth';
import { FormControl, FormGroup, Validators } from '@angular/forms';
import { EMAIL_REGEX, PHONE_NUMBER_REGEX } from '..';
import { NgxAuthFirebaseUIConfigToken } from '../../tokens';
import { AuthProcessService } from '../../services/auth-process.service';
import { FirestoreSyncService } from '../../services/firestore-sync.service';
let UserComponent = class UserComponent {
    constructor(auth, authProcess, fireStoreService, config) {
        this.auth = auth;
        this.authProcess = authProcess;
        this.fireStoreService = fireStoreService;
        this.config = config;
        this.canLogout = true;
        this.canEditAccount = true;
        this.canDeleteAccount = true;
        // tslint:disable-next-line:no-output-on-prefix
        this.onSignOut = new EventEmitter();
        // tslint:disable-next-line:no-output-on-prefix
        this.onAccountEdited = new EventEmitter();
        // tslint:disable-next-line:no-output-on-prefix
        this.onAccountDeleted = new EventEmitter();
    }
    changeEditMode() {
        this.editMode = !this.editMode;
        this.editMode ? this.initUpdateFormGroup() : this.reset();
    }
    reset() {
        this.updateFormGroup.reset();
        this.updateFormGroup.disable();
        this.updateFormGroup = null;
    }
    save() {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.updateFormGroup.dirty) {
                const user = this.authProcess.user;
                // ngx-auth-firebaseui-user.updateProfile()
                // ngx-auth-firebaseui-user.updateEmail()
                // console.log('form = ', this.updateFormGroup);
                const snackBarMsg = [];
                try {
                    if (this.updateNameFormControl.dirty) {
                        yield user.updateProfile({ displayName: this.updateNameFormControl.value });
                        snackBarMsg.push(`your name has been updated to ${user.displayName}`);
                    }
                    if (this.updateEmailFormControl.dirty) {
                        yield user.updateEmail(this.updateEmailFormControl.value);
                        snackBarMsg.push(`your email has been updated to ${user.email}`);
                    }
                    if (this.updatePhoneNumberFormControl.dirty) {
                        yield user.updatePhoneNumber(this.updatePhoneNumberFormControl.value);
                        console.log('phone number = ', this.updatePhoneNumberFormControl.value);
                        snackBarMsg.push(`your phone number has been updated to ${user.phoneNumber}`);
                    }
                    if (this.config.enableFirestoreSync) {
                        yield this.fireStoreService.updateUserData(this.authProcess.parseUserInfo(user));
                    }
                }
                catch (error) {
                    this.authProcess.showToast(error && error.message ? error.message : error);
                    console.error(error);
                }
                if (snackBarMsg.length > 0) {
                    this.authProcess.showToast(snackBarMsg.join('\\n'));
                }
                // this.updateFormGroup.reset();
            }
            this.editMode = false;
        });
    }
    signOut() {
        this.auth.signOut()
            .then(() => this.onSignOut.emit())
            .catch(e => console.error('An error happened while signing out!', e));
    }
    /**
     * Delete the account of the current firebase ngx-auth-firebaseui-user
     *
     * On Success, emit the <onAccountDeleted> event and toast a msg!#
     * Otherwise, log the and toast and error msg!
     *
     */
    deleteAccount() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const user = this.authProcess.user;
                // await this.authProcess.deleteAccount();
                yield this.authProcess.user.delete();
                // if (this.config.enableFirestoreSync) {
                yield this.fireStoreService.deleteUserData(user.uid);
                // }
                this.onAccountDeleted.emit();
                this.editMode = false;
                console.log('Your account has been successfully deleted!');
                this.authProcess.showToast('Your account has been successfully deleted!');
            }
            catch (error) {
                console.log('Error while delete user account', error);
                this.authProcess.showToast(`Error occurred while deleting your account: ${error.message}`);
            }
        });
    }
    initUpdateFormGroup() {
        const currentUser = this.authProcess.user;
        this.updateFormGroup = new FormGroup({
            name: this.updateNameFormControl = new FormControl({ value: currentUser.displayName, disabled: this.editMode }, [
                Validators.required,
                Validators.minLength(this.config.nameMinLength),
                Validators.maxLength(this.config.nameMaxLength)
            ]),
            email: this.updateEmailFormControl = new FormControl({ value: currentUser.email, disabled: this.editMode }, [
                Validators.required,
                Validators.pattern(EMAIL_REGEX)
            ]),
            phoneNumber: this.updatePhoneNumberFormControl = new FormControl({ value: currentUser.phoneNumber, disabled: this.editMode }, [Validators.pattern(PHONE_NUMBER_REGEX)])
        });
        this.updateFormGroup.enable();
    }
};
UserComponent.ctorParameters = () => [
    { type: AngularFireAuth },
    { type: AuthProcessService },
    { type: FirestoreSyncService },
    { type: undefined, decorators: [{ type: Inject, args: [forwardRef(() => NgxAuthFirebaseUIConfigToken),] }] }
];
__decorate([
    Input()
], UserComponent.prototype, "editMode", void 0);
__decorate([
    Input()
], UserComponent.prototype, "canLogout", void 0);
__decorate([
    Input()
], UserComponent.prototype, "canEditAccount", void 0);
__decorate([
    Input()
], UserComponent.prototype, "canDeleteAccount", void 0);
__decorate([
    Input()
], UserComponent.prototype, "appearance", void 0);
__decorate([
    Output()
], UserComponent.prototype, "onSignOut", void 0);
__decorate([
    Output()
], UserComponent.prototype, "onAccountEdited", void 0);
__decorate([
    Output()
], UserComponent.prototype, "onAccountDeleted", void 0);
UserComponent = __decorate([
    Component({
        selector: 'ngx-auth-firebaseui-user',
        template: "<div *ngIf=\"auth.authState| async as user; then authenticated else none\">\n\n</div>\n\n<ng-template #authenticated>\n  <mat-card *ngIf=\"auth.user | async as user\">\n    <!--<form [formGroup]=\"updateFormGroup\" >-->\n    <!--card header-->\n    <mat-card-header fxLayout=\"column\" fxLayoutAlign=\"center center\">\n\n      <img [src]=\"authProcess?.getUserPhotoUrl()\" mat-card-avatar>\n\n      <div *ngIf=\"user.emailVerified; then emailVerified else emailNotVerified\"></div>\n      <ng-template #emailVerified>\n        <mat-icon color=\"primary\"\n                  matTooltip=\"email is verified\"\n                  matTooltipPosition=\"after\">\n          verified_user\n        </mat-icon>\n      </ng-template>\n      <ng-template #emailNotVerified>\n        <mat-icon color=\"warn\"\n                  matTooltip=\"email is not verified\"\n                  matTooltipPosition=\"after\">\n          warning\n        </mat-icon>\n      </ng-template>\n\n    </mat-card-header>\n\n    <!--card content-->\n    <mat-card-content *ngIf=\"editMode; then edit else readonly\">\n    </mat-card-content>\n\n    <ng-template #edit>\n      <form (submit)=\"save()\" [formGroup]=\"updateFormGroup\">\n\n        <mat-card-content fxLayout=\"column\" fxLayoutAlign=\"center center\">\n          <div fxLayoutAlign=\"center\">\n            <button (click)=\"changeEditMode()\" class=\"edit-button\" color=\"warn\"\n                    mat-raised-button>\n              cancel\n            </button>\n          </div>\n\n          <!--name-->\n          <mat-form-field [appearance]=\"appearance\" class=\"full-width\">\n            <mat-label>Name</mat-label>\n            <input [formControl]=\"updateNameFormControl\"\n                   matInput\n                   placeholder=\"Name\">\n            <mat-icon matSuffix>person</mat-icon>\n            <mat-hint align=\"end\" aria-live=\"polite\"> {{ updateNameFormControl.value?.length }}\n              / {{ config.nameMaxLength }} </mat-hint>\n            <mat-error *ngIf=\"updateNameFormControl.hasError('required')\">\n              Name is required\n            </mat-error>\n          </mat-form-field>\n\n          <!--email-->\n          <mat-form-field [appearance]=\"appearance\" class=\"full-width\">\n            <mat-label>E-mail</mat-label>\n            <input [formControl]=\"updateEmailFormControl\"\n                   matInput\n                   placeholder=\"E-mail\">\n            <mat-icon matSuffix>email</mat-icon>\n            <mat-error *ngIf=\"updateEmailFormControl.hasError('required')\">\n              E-mail is required {{updateEmailFormControl.value}}\n            </mat-error>\n            <mat-error *ngIf=\"updateEmailFormControl.hasError('pattern')\">\n              Please enter a valid e-mail address {{updateEmailFormControl.value}}\n            </mat-error>\n          </mat-form-field>\n\n          <!--phone number-->\n          <mat-form-field *ngIf=\"false\" [appearance]=\"appearance\" class=\"full-width\">\n            <mat-label>Phone number</mat-label>\n            <input [formControl]=\"updatePhoneNumberFormControl\"\n                   matInput\n                   placeholder=\"Phone number\"\n                   type=\"tel\">\n            <mat-icon matSuffix>phone</mat-icon>\n            <mat-hint align=\"end\" aria-live=\"polite\">\n              The phone number is international. Therefore, it should start with a + sign or 00,\n              followed by the country code, - and national number e.g: +49-12345678 or 0041-1234567890\n\n              NOTE : the phone number must be a valid phone credential !!\n            </mat-hint>\n            <mat-error *ngIf=\"updatePhoneNumberFormControl.hasError('pattern')\">\n              Please enter a valid phone number\n            </mat-error>\n          </mat-form-field>\n\n        </mat-card-content>\n\n        <mat-card-actions fxLayout=\"column\">\n          <button color=\"primary\"\n                  mat-button\n                  type=\"submit\">\n            Save changes\n          </button>\n        </mat-card-actions>\n      </form>\n    </ng-template>\n\n    <ng-template #readonly>\n      <div fxLayoutAlign=\"center\">\n        <button (click)=\"changeEditMode()\" class=\"edit-button\" color=\"primary\"\n                mat-raised-button>\n          edit\n        </button>\n      </div>\n\n      <!--name-->\n      <mat-form-field [appearance]=\"appearance\" class=\"full-width\">\n        <mat-label>Name</mat-label>\n        <input [disabled]=\"!editMode\"\n               [value]=\"user.displayName\"\n               matInput\n               placeholder=\"Name\">\n        <mat-icon color=\"primary\" matSuffix>person</mat-icon>\n      </mat-form-field>\n\n      <!--email-->\n      <mat-form-field [appearance]=\"appearance\" class=\"full-width\">\n        <mat-label>E-mail</mat-label>\n        <input [disabled]=\"!editMode\"\n               [value]=\"user.email\" matInput\n               placeholder=\"E-mail\">\n        <mat-icon color=\"primary\" matSuffix>email</mat-icon>\n      </mat-form-field>\n\n      <!--phone number-->\n      <mat-form-field *ngIf=\"false\" [appearance]=\"appearance\" class=\"full-width\">\n        <mat-label>Phone number</mat-label>\n        <input [disabled]=\"!editMode\"\n               [value]=\"user.phoneNumber\"\n               matInput\n               placeholder=\"Phone number\">\n        <mat-icon color=\"primary\" matSuffix>phone</mat-icon>\n      </mat-form-field>\n\n      <mat-card-actions fxLayout=\"column\">\n        <button (click)=\"signOut()\" *ngIf=\"canLogout\" color=\"primary\" mat-button>Sign out</button>\n        <button (click)=\"deleteAccount()\" *ngIf=\"canDeleteAccount\" color=\"warn\" mat-button>Delete account</button>\n      </mat-card-actions>\n\n    </ng-template>\n\n  </mat-card>\n\n</ng-template>\n\n\n<ng-template #none>\n  <mat-card class=\"none-card\" fxLayout=\"row\" fxLayoutAlign=\"center center\">\n    <mat-card-content fxLayout=\"row\" fxLayoutAlign=\"center center\">\n      <mat-icon color=\"accent\">warning</mat-icon>\n      <span>You are not logged in!</span>\n    </mat-card-content>\n  </mat-card>\n</ng-template>\n",
        styles: [".edit-button{margin:1rem}.full-width{width:100%}.cut-text{text-overflow:ellipsis;overflow:hidden;white-space:nowrap}.none-card{min-height:430px}.none-card span{font-size:24px;text-align:center;color:rgba(0,0,0,.54)}"]
    }),
    __param(3, Inject(forwardRef(() => NgxAuthFirebaseUIConfigToken)))
], UserComponent);
export { UserComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtYXV0aC1maXJlYmFzZXVpLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvbmd4LWF1dGgtZmlyZWJhc2V1aS11c2VyL3VzZXIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUMsU0FBUyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDekYsT0FBTyxFQUFDLGVBQWUsRUFBQyxNQUFNLG9CQUFvQixDQUFDO0FBQ25ELE9BQU8sRUFBQyxXQUFXLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBRWxFLE9BQU8sRUFBQyxXQUFXLEVBQUUsa0JBQWtCLEVBQUMsTUFBTSxJQUFJLENBQUM7QUFFbkQsT0FBTyxFQUFDLDRCQUE0QixFQUFDLE1BQU0sY0FBYyxDQUFDO0FBRTFELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3pFLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLHVDQUF1QyxDQUFDO0FBTzdFLElBQWEsYUFBYSxHQUExQixNQUFhLGFBQWE7SUFtQ3hCLFlBQ1MsSUFBcUIsRUFDckIsV0FBK0IsRUFDOUIsZ0JBQXNDLEVBQ2lCLE1BQStCO1FBSHZGLFNBQUksR0FBSixJQUFJLENBQWlCO1FBQ3JCLGdCQUFXLEdBQVgsV0FBVyxDQUFvQjtRQUM5QixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQXNCO1FBQ2lCLFdBQU0sR0FBTixNQUFNLENBQXlCO1FBakNoRyxjQUFTLEdBQUcsSUFBSSxDQUFDO1FBR2pCLG1CQUFjLEdBQUcsSUFBSSxDQUFDO1FBR3RCLHFCQUFnQixHQUFHLElBQUksQ0FBQztRQUt4QiwrQ0FBK0M7UUFFL0MsY0FBUyxHQUF1QixJQUFJLFlBQVksRUFBRSxDQUFDO1FBRW5ELCtD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QyxLQUFLLEVBQUU7dURBQ2dCO0FBR3hCO0lBREMsS0FBSyxFQUFFO2lEQUMyQjtBQUluQztJQURDLE1BQU0sRUFBRTtnREFDMEM7QUFJbkQ7SUFEQyxNQUFNLEVBQUU7c0RBQ2dEO0FBSXpEO0lBREMsTUFBTSxFQUFFO3VEQUNpRDtBQTNCL0MsYUFBYTtJQUx6QixTQUFTLENBQUM7UUFDVCxRQUFRLEVBQUUsMEJBQTBCO1FBQ3BDLG1rTUFBb0M7O0tBRXJDLENBQUM7SUF3Q0csV0FBQSxNQUFNLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLDRCQUE0QixDQUFDLENBQUMsQ0FBQTtHQXZDOUMsYUFBYSxDQThKekI7U0E5SlksYUFBYSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q29tcG9uZW50LCBFdmVudEVtaXR0ZXIsIGZvcndhcmRSZWYsIEluamVjdCwgSW5wdXQsIE91dHB1dH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0FuZ3VsYXJGaXJlQXV0aH0gZnJvbSAnQGFuZ3VsYXIvZmlyZS9hdXRoJztcbmltcG9ydCB7Rm9ybUNvbnRyb2wsIEZvcm1Hcm91cCwgVmFsaWRhdG9yc30gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHtVc2VyfSBmcm9tICdmaXJlYmFzZSc7XG5pbXBvcnQge0VNQUlMX1JFR0VYLCBQSE9ORV9OVU1CRVJfUkVHRVh9IGZyb20gJy4uJztcbmltcG9ydCB7TWF0Rm9ybUZpZWxkQXBwZWFyYW5jZX0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvZm9ybS1maWVsZCc7XG5pbXBvcnQge05neEF1dGhGaXJlYmFzZVVJQ29uZmlnVG9rZW59IGZyb20gJy4uLy4uL3Rva2Vucyc7XG5pbXBvcnQge05neEF1dGhGaXJlYmFzZVVJQ29uZmlnfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7IEF1dGhQcm9jZXNzU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2F1dGgtcHJvY2Vzcy5zZXJ2aWNlJztcbmltcG9ydCB7IEZpcmVzdG9yZVN5bmNTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvZmlyZXN0b3JlLXN5bmMuc2VydmljZSc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ25neC1hdXRoLWZpcmViYXNldWktdXNlcicsXG4gIHRlbXBsYXRlVXJsOiAnLi91c2VyLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vdXNlci5jb21wb25lbnQuc2NzcyddXG59KVxuZXhwb3J0IGNsYXNzIFVzZXJDb21wb25lbnQge1xuXG4gIEBJbnB1dCgpXG4gIGVkaXRNb2RlOiBib29sZWFuO1xuXG4gIEBJbnB1dCgpXG4gIGNhbkxvZ291dCA9IHRydWU7XG5cbiAgQElucHV0KClcbiAgY2FuRWRpdEFjY291bnQgPSB0cnVlO1xuXG4gIEBJbnB1dCgpXG4gIGNhbkRlbGV0ZUFjY291bnQgPSB0cnVlO1xuXG4gIEBJbnB1dCgpXG4gIGFwcGVhcmFuY2U6IE1hdEZvcm1GaWVsZEFwcGVhcmFuY2U7XG5cbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLW91dHB1dC1vbi1wcmVmaXhcbiAgQE91dHB1dCgpXG4gIG9uU2lnbk91dDogRXZlbnRFbWl0dGVyPHZvaWQ+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1vdXRwdXQtb24tcHJlZml4XG4gIEBPdXRwdXQoKVxuICBvbkFjY291bnRFZGl0ZWQ6IEV2ZW50RW1pdHRlcjx2b2lkPiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tb3V0cHV0LW9uLXByZWZpeFxuICBAT3V0cHV0KClcbiAgb25BY2NvdW50RGVsZXRlZDogRXZlbnRFbWl0dGVyPHZvaWQ+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIHVwZGF0ZUZvcm1Hcm91cDogRm9ybUdyb3VwO1xuICB1cGRhdGVOYW1lRm9ybUNvbnRyb2w6IEZvcm1Db250cm9sO1xuICB1cGRhdGVFbWFpbEZvcm1Db250cm9sOiBGb3JtQ29udHJvbDtcbiAgdXBkYXRlUGhvbmVOdW1iZXJGb3JtQ29udHJvbDogRm9ybUNvbnRyb2w7XG4gIHVwZGF0ZVBhc3N3b3JkRm9ybUNvbnRyb2w6IEZvcm1Db250cm9sO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBhdXRoOiBBbmd1bGFyRmlyZUF1dGgsXG4gICAgcHVibGljIGF1dGhQcm9jZXNzOiBBdXRoUHJvY2Vzc1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBmaXJlU3RvcmVTZXJ2aWNlOiBGaXJlc3RvcmVTeW5jU2VydmljZSxcbiAgICBASW5qZWN0KGZvcndhcmRSZWYoKCkgPT4gTmd4QXV0aEZpcmViYXNlVUlDb25maWdUb2tlbikpIHB1YmxpYyBjb25maWc6IE5neEF1dGhGaXJlYmFzZVVJQ29uZmlnXG4gICkge1xuICB9XG5cbiAgY2hhbmdlRWRpdE1vZGUoKSB7XG4gICAgdGhpcy5lZGl0TW9kZSA9ICF0aGlzLmVkaXRNb2RlO1xuXG4gICAgdGhpcy5lZGl0TW9kZSA/IHRoaXMuaW5pdFVwZGF0ZUZvcm1Hcm91cCgpIDogdGhpcy5yZXNldCgpO1xuICB9XG5cbiAgcmVzZXQoKSB7XG4gICAgdGhpcy51cGRhdGVGb3JtR3JvdXAucmVzZXQoKTtcbiAgICB0aGlzLnVwZGF0ZUZvcm1Hcm91cC5kaXNhYmxlKCk7XG4gICAgdGhpcy51cGRhdGVGb3JtR3JvdXAgPSBudWxsO1xuICB9XG5cbiAgYXN5bmMgc2F2ZSgpIHtcbiAgICBpZiAodGhpcy51cGRhdGVGb3JtR3JvdXAuZGlydHkpIHtcbiAgICAgIGNvbnN0IHVzZXIgPSB0aGlzLmF1dGhQcm9jZXNzLnVzZXI7XG4gICAgICAvLyBuZ3gtYXV0aC1maXJlYmFzZXVpLXVzZXIudXBkYXRlUHJvZmlsZSgpXG4gICAgICAvLyBuZ3gtYXV0aC1maXJlYmFzZXVpLXVzZXIudXBkYXRlRW1haWwoKVxuICAgICAgLy8gY29uc29sZS5sb2coJ2Zvcm0gPSAnLCB0aGlzLnVwZGF0ZUZvcm1Hcm91cCk7XG5cbiAgICAgIGNvbnN0IHNuYWNrQmFyTXNnOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgICB0cnkge1xuICAgICAgICBpZiAodGhpcy51cGRhdGVOYW1lRm9ybUNvbnRyb2wuZGlydHkpIHtcbiAgICAgICAgICBhd2FpdCB1c2VyLnVwZGF0ZVByb2ZpbGUoe2Rpc3BsYXlOYW1lOiB0aGlzLnVwZGF0ZU5hbWVGb3JtQ29udHJvbC52YWx1ZX0pO1xuICAgICAgICAgIHNuYWNrQmFyTXNnLnB1c2goYHlvdXIgbmFtZSBoYXMgYmVlbiB1cGRhdGVkIHRvICR7dXNlci5kaXNwbGF5TmFtZX1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLnVwZGF0ZUVtYWlsRm9ybUNvbnRyb2wuZGlydHkpIHtcbiAgICAgICAgICBhd2FpdCB1c2VyLnVwZGF0ZUVtYWlsKHRoaXMudXBkYXRlRW1haWxGb3JtQ29udHJvbC52YWx1ZSk7XG4gICAgICAgICAgc25hY2tCYXJNc2cucHVzaChgeW91ciBlbWFpbCBoYXMgYmVlbiB1cGRhdGVkIHRvICR7dXNlci5lbWFpbH1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLnVwZGF0ZVBob25lTnVtYmVyRm9ybUNvbnRyb2wuZGlydHkpIHtcbiAgICAgICAgICBhd2FpdCB1c2VyLnVwZGF0ZVBob25lTnVtYmVyKHRoaXMudXBkYXRlUGhvbmVOdW1iZXJGb3JtQ29udHJvbC52YWx1ZSk7XG4gICAgICAgICAgY29uc29sZS5sb2coJ3Bob25lIG51bWJlciA9ICcsIHRoaXMudXBkYXRlUGhvbmVOdW1iZXJGb3JtQ29udHJvbC52YWx1ZSk7XG4gICAgICAgICAgc25hY2tCYXJNc2cucHVzaChgeW91ciBwaG9uZSBudW1iZXIgaGFzIGJlZW4gdXBkYXRlZCB0byAke3VzZXIucGhvbmVOdW1iZXJ9YCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5jb25maWcuZW5hYmxlRmlyZXN0b3JlU3luYykge1xuICAgICAgICAgIGF3YWl0IHRoaXMuZmlyZVN0b3JlU2VydmljZS51cGRhdGVVc2VyRGF0YSh0aGlzLmF1dGhQcm9jZXNzLnBhcnNlVXNlckluZm8odXNlcikpO1xuICAgICAgICB9XG5cbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHRoaXMuYXV0aFByb2Nlc3Muc2hvd1RvYXN0KGVycm9yICYmIGVycm9yLm1lc3NhZ2UgPyBlcnJvci5tZXNzYWdlIDogZXJyb3IpO1xuICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgIH1cblxuXG4gICAgICBpZiAoc25hY2tCYXJNc2cubGVuZ3RoID4gMCkge1xuICAgICAgICB0aGlzLmF1dGhQcm9jZXNzLnNob3dUb2FzdChzbmFja0Jhck1zZy5qb2luKCdcXFxcbicpKTtcbiAgICAgIH1cbiAgICAgIC8vIHRoaXMudXBkYXRlRm9ybUdyb3VwLnJlc2V0KCk7XG4gICAgfVxuXG4gICAgdGhpcy5lZGl0TW9kZSA9IGZhbHNlO1xuICB9XG5cbiAgc2lnbk91dCgpIHtcbiAgICB0aGlzLmF1dGguc2lnbk91dCgpXG4gICAgICAudGhlbigoKSA9PiB0aGlzLm9uU2lnbk91dC5lbWl0KCkpXG4gICAgICAuY2F0Y2goZSA9PiBjb25zb2xlLmVycm9yKCdBbiBlcnJvciBoYXBwZW5lZCB3aGlsZSBzaWduaW5nIG91dCEnLCBlKSk7XG4gIH1cblxuICAvKipcbiAgICogRGVsZXRlIHRoZSBhY2NvdW50IG9mIHRoZSBjdXJyZW50IGZpcmViYXNlIG5neC1hdXRoLWZpcmViYXNldWktdXNlclxuICAgKlxuICAgKiBPbiBTdWNjZXNzLCBlbWl0IHRoZSA8b25BY2NvdW50RGVsZXRlZD4gZXZlbnQgYW5kIHRvYXN0IGEgbXNnISNcbiAgICogT3RoZXJ3aXNlLCBsb2cgdGhlIGFuZCB0b2FzdCBhbmQgZXJyb3IgbXNnIVxuICAgKlxuICAgKi9cbiAgYXN5bmMgZGVsZXRlQWNjb3VudCgpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdXNlciA9IHRoaXMuYXV0aFByb2Nlc3MudXNlcjtcblxuICAgICAgLy8gYXdhaXQgdGhpcy5hdXRoUHJvY2Vzcy5kZWxldGVBY2NvdW50KCk7XG4gICAgICBhd2FpdCB0aGlzLmF1dGhQcm9jZXNzLnVzZXIuZGVsZXRlKCk7XG4gICAgICAvLyBpZiAodGhpcy5jb25maWcuZW5hYmxlRmlyZXN0b3JlU3luYykge1xuICAgICAgYXdhaXQgdGhpcy5maXJlU3RvcmVTZXJ2aWNlLmRlbGV0ZVVzZXJEYXRhKHVzZXIudWlkKTtcbiAgICAgIC8vIH1cbiAgICAgIHRoaXMub25BY2NvdW50RGVsZXRlZC5lbWl0KCk7XG4gICAgICB0aGlzLmVkaXRNb2RlID0gZmFsc2U7XG4gICAgICBjb25zb2xlLmxvZygnWW91ciBhY2NvdW50IGhhcyBiZWVuIHN1Y2Nlc3NmdWxseSBkZWxldGVkIScpO1xuICAgICAgdGhpcy5hdXRoUHJvY2Vzcy5zaG93VG9hc3QoJ1lvdXIgYWNjb3VudCBoYXMgYmVlbiBzdWNjZXNzZnVsbHkgZGVsZXRlZCEnKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5sb2coJ0Vycm9yIHdoaWxlIGRlbGV0ZSB1c2VyIGFjY291bnQnLCBlcnJvcik7XG4gICAgICB0aGlzLmF1dGhQcm9jZXNzLnNob3dUb2FzdChgRXJyb3Igb2NjdXJyZWQgd2hpbGUgZGVsZXRpbmcgeW91ciBhY2NvdW50OiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIGluaXRVcGRhdGVGb3JtR3JvdXAoKSB7XG4gICAgY29uc3QgY3VycmVudFVzZXI6IFVzZXIgPSB0aGlzLmF1dGhQcm9jZXNzLnVzZXI7XG4gICAgdGhpcy51cGRhdGVGb3JtR3JvdXAgPSBuZXcgRm9ybUdyb3VwKHtcbiAgICAgIG5hbWU6IHRoaXMudXBkYXRlTmFtZUZvcm1Db250cm9sID0gbmV3IEZvcm1Db250cm9sKFxuICAgICAgICB7dmFsdWU6IGN1cnJlbnRVc2VyLmRpc3BsYXlOYW1lLCBkaXNhYmxlZDogdGhpcy5lZGl0TW9kZX0sXG4gICAgICAgIFtcbiAgICAgICAgICBWYWxpZGF0b3JzLnJlcXVpcmVkLFxuICAgICAgICAgIFZhbGlkYXRvcnMubWluTGVuZ3RoKHRoaXMuY29uZmlnLm5hbWVNaW5MZW5ndGgpLFxuICAgICAgICAgIFZhbGlkYXRvcnMubWF4TGVuZ3RoKHRoaXMuY29uZmlnLm5hbWVNYXhMZW5ndGgpXG4gICAgICAgIF1cbiAgICAgICksXG5cbiAgICAgIGVtYWlsOiB0aGlzLnVwZGF0ZUVtYWlsRm9ybUNvbnRyb2wgPSBuZXcgRm9ybUNvbnRyb2woXG4gICAgICAgIHt2YWx1ZTogY3VycmVudFVzZXIuZW1haWwsIGRpc2FibGVkOiB0aGlzLmVkaXRNb2RlfSxcbiAgICAgICAgW1xuICAgICAgICAgIFZhbGlkYXRvcnMucmVxdWlyZWQsXG4gICAgICAgICAgVmFsaWRhdG9ycy5wYXR0ZXJuKEVNQUlMX1JFR0VYKVxuICAgICAgICBdKSxcblxuICAgICAgcGhvbmVOdW1iZXI6IHRoaXMudXBkYXRlUGhvbmVOdW1iZXJGb3JtQ29udHJvbCA9IG5ldyBGb3JtQ29udHJvbChcbiAgICAgICAge3ZhbHVlOiBjdXJyZW50VXNlci5waG9uZU51bWJlciwgZGlzYWJsZWQ6IHRoaXMuZWRpdE1vZGV9LFxuICAgICAgICBbVmFsaWRhdG9ycy5wYXR0ZXJuKFBIT05FX05VTUJFUl9SRUdFWCldKVxuICAgIH0pO1xuXG4gICAgdGhpcy51cGRhdGVGb3JtR3JvdXAuZW5hYmxlKCk7XG4gIH1cbn1cbiJdfQ==