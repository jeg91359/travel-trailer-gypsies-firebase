import { __awaiter, __decorate, __generator, __param } from "tslib";
import { EventEmitter, forwardRef, Inject, Injectable } from '@angular/core';
import { AngularFireAuth } from '@angular/fire/auth';
import { firebase } from '@firebase/app';
import '@firebase/auth';
import { tap } from 'rxjs/operators';
import { Accounts } from '../enums';
import { FirestoreSyncService } from './firestore-sync.service';
import { MAT_SNACK_BAR_DEFAULT_OPTIONS, MatSnackBar, MatSnackBarConfig } from '@angular/material/snack-bar';
import { NgxAuthFirebaseUIConfigToken } from '../tokens';
import * as i0 from "@angular/core";
import * as i1 from "@angular/fire/auth";
import * as i2 from "../tokens/index";
import * as i3 from "@angular/material/snack-bar";
import * as i4 from "./firestore-sync.service";
export var facebookAuthProvider = new firebase.auth.FacebookAuthProvider();
export var googleAuthProvider = new firebase.auth.GoogleAuthProvider();
export var appleAuthProvider = new firebase.auth.OAuthProvider('apple.com');
export var twitterAuthProvider = new firebase.auth.TwitterAuthProvider();
export var githubAuthProvider = new firebase.auth.GithubAuthProvider();
export var microsoftAuthProvider = new firebase.auth.OAuthProvider('microsoft.com');
export var yahooAuthProvider = new firebase.auth.OAuthProvider('yahoo.com');
export var AuthProvider;
(function (AuthProvider) {
    AuthProvider["ALL"] = "all";
    AuthProvider["ANONYMOUS"] = "anonymous";
    AuthProvider["EmailAndPassword"] = "firebase";
    AuthProvider["Google"] = "google";
    AuthProvider["Apple"] = "Apple";
    AuthProvider["Facebook"] = "facebook";
    AuthProvider["Twitter"] = "twitter";
    AuthProvider["Github"] = "github";
    AuthProvider["Microsoft"] = "microsoft";
    AuthProvider["Yahoo"] = "yahoo";
    AuthProvider["PhoneNumber"] = "phoneNumber";
})(AuthProvider || (AuthProvider = {}));
var AuthProcessService = /** @class */ (function () {
    function AuthProcessService(afa, config, snackBar, fireStoreService, matSnackBarConfig) {
        this.afa = afa;
        this.config = config;
        this.snackBar = snackBar;
        this.fireStoreService = fireStoreService;
        this.matSnackBarConfig = matSnackBarConfig;
        this.onSuccessEmitter = new EventEmitter();
        this.onErrorEmitter = new EventEmitter();
    }
    AuthProcessService.prototype.listenToUserEvents = function () {
        var _this = this;
        this.user$ = this.afa.user.pipe(tap(function (user) {
            _this.user = user;
        }));
    };
    /**
     * Reset the password of the ngx-auth-firebaseui-user via email
     *
     * @param email - the email to reset
     */
    AuthProcessService.prototype.resetPassword = function (email) {
        return __awaiter(this, void 0, void 0, function () {
            var error_1;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 2, , 3]);
                        console.log('Password reset email sent');
                        return [4 /*yield*/, this.afa.sendPasswordResetEmail(email)];
                    case 1: return [2 /*return*/, _a.sent()];
                    case 2:
                        error_1 = _a.sent();
                        return [2 /*return*/, this.notifyError(error_1)];
                    case 3: return [2 /*return*/];
                }
            });
        });
    };
    /**
     * General sign in mechanism to authenticate the users with a firebase project
     * using a traditional way, via username and password or by using an authentication provider
     * like google, facebook, twitter and github
     *
     * @param provider - the provider to authenticate with (google, facebook, twitter, github)
     // tslint:disable-next-line:no-redundant-jsdoc
     * @param credentials
     */
    AuthProcessService.prototype.signInWith = function (provider, credentials) {
        return __awaiter(this, void 0, void 0, function () {
            var signInResult, _a, err_1;
            return __generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        _b.trys.push([0, 23, , 24]);
                        signInResult = void 0;
                        _a = provider;
                        switch (_a) {
                            case AuthProvider.ANONYMOUS: return [3 /*break*/, 1];
                            case AuthProvider.EmailAndPassword: return [3 /*break*/, 3];
                            case AuthProvider.Google: return [3 /*break*/, 5];
                            case AuthProvider.Apple: return [3 /*break*/, 7];
                            case AuthProvider.Facebook: return [3 /*break*/, 9];
                            case AuthProvider.Twitter: return [3 /*break*/, 11];
                            case AuthProvider.Github: return [3 /*break*/, 13];
                            case AuthProvider.Microsoft: return [3 /*break*/, 15];
                            case AuthProvider.Yahoo: return [3 /*break*/, 17];
                            case AuthProvider.PhoneNumber: return [3 /*break*/, 19];
                        }
                        return [3 /*break*/, 20];
                    case 1: return [4 /*yield*/, this.afa.signInAnonymously()];
                    case 2:
                        signInResult = (_b.sent());
                        return [3 /*break*/, 21];
                    case 3: return [4 /*yield*/, this.afa.signInWithEmailAndPassword(credentials.email, credentials.password)];
                    case 4:
                        signInResult = (_b.sent());
                        return [3 /*break*/, 21];
                    case 5: return [4 /*yield*/, this.afa.signInWithPopup(googleAuthProvider)];
                    case 6:
                        signInResult = (_b.sent());
                        return [3 /*break*/, 21];
                    case 7: return [4 /*yield*/, this.afa.signInWithPopup(appleAuthProvider)];
                    case 8:
                        signInResult = (_b.sent());
                        return [3 /*break*/, 21];
                    case 9: return [4 /*yield*/, this.afa.signInWithPopup(facebookAuthProvider)];
                    case 10:
                        signInResult = (_b.sent());
                        return [3 /*break*/, 21];
                    case 11: return [4 /*yield*/, this.afa.signInWithPopup(twitterAuthProvider)];
                    case 12:
                        signInResult = (_b.sent());
                        return [3 /*break*/, 21];
                    case 13: return [4 /*yield*/, this.afa.signInWithPopup(githubAuthProvider)];
                    case 14:
                        signInResult = (_b.sent());
                        return [3 /*break*/, 21];
                    case 15: return [4 /*yield*/, this.afa.signInWithPopup(microsoftAuthProvider)];
                    case 16:
                        signInResult = (_b.sent());
                        return [3 /*break*/, 21];
                    case 17: return [4 /*yield*/, this.afa.signInWithPopup(yahooAuthProvider)];
                    case 18:
                        signInResult = (_b.sent());
                        return [3 /*break*/, 21];
                    case 19: 
                    // coming soon - see feature/sms branch
                    return [3 /*break*/, 21];
                    case 20: throw new Error(AuthProvider[provider] + " is not available as auth provider");
                    case 21: return [4 /*yield*/, this.handleSuccess(signInResult)];
                    case 22:
                        _b.sent();
                        return [3 /*break*/, 24];
                    case 23:
                        err_1 = _b.sent();
                        this.handleError(err_1);
                        return [3 /*break*/, 24];
                    case 24: return [2 /*return*/];
                }
            });
        });
    };
    /**
     * Sign up new users via email and password.
     * After that the ngx-auth-firebaseui-user should verify and confirm an email sent via the firebase
     *
     * @param displayName - the displayName if the new ngx-auth-firebaseui-user
     * @returns -
     */
    AuthProcessService.prototype.signUp = function (displayName, credentials) {
        return __awaiter(this, void 0, void 0, function () {
            var userCredential, user, err_2;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 8, , 9]);
                        return [4 /*yield*/, this.afa.createUserWithEmailAndPassword(credentials.email, credentials.password)];
                    case 1:
                        userCredential = _a.sent();
                        user = userCredential.user;
                        return [4 /*yield*/, this.updateProfile(displayName, user.photoURL)];
                    case 2:
                        _a.sent();
                        if (!this.config.enableFirestoreSync) return [3 /*break*/, 4];
                        return [4 /*yield*/, this.fireStoreService
                                .getUserDocRefByUID(user.uid)
                                .set({
                                uid: user.uid,
                                displayName: displayName,
                                email: user.email,
                                photoURL: user.photoURL
                            })];
                    case 3:
                        _a.sent();
                        _a.label = 4;
                    case 4:
                        if (!this.config.enableEmailVerification) return [3 /*break*/, 6];
                        return [4 /*yield*/, user.sendEmailVerification()];
                    case 5:
                        _a.sent();
                        _a.label = 6;
                    case 6:
                        // Legacy fields
                        this.emailConfirmationSent = true;
                        this.emailToConfirm = credentials.email;
                        return [4 /*yield*/, this.handleSuccess(userCredential)];
                    case 7:
                        _a.sent();
                        return [3 /*break*/, 9];
                    case 8:
                        err_2 = _a.sent();
                        this.handleError(err_2);
                        return [3 /*break*/, 9];
                    case 9: return [2 /*return*/];
                }
            });
        });
    };
    AuthProcessService.prototype.sendNewVerificationEmail = function () {
        return __awaiter(this, void 0, void 0, function () {
            return __generator(this, function (_a) {
                if (!this.user) {
                    return [2 /*return*/, Promise.reject(new Error('No signed in user'))];
                }
                return [2 /*return*/, this.user.sendEmailVerification()];
            });
        });
    };
    AuthProcessService.prototype.signOut = function () {
        return __awaiter(this, void 0, void 0, function () {
            var error_2;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 2, , 3]);
                        return [4 /*yield*/, this.afa.signOut()];
                    case 1:
                        _a.sent();
                        return [3 /*break*/, 3];
                    case 2:
                        error_2 = _a.sent();
                        this.notifyError(error_2);
                        return [3 /*break*/, 3];
                    case 3: return [2 /*return*/];
                }
            });
        });
    };
    /**
     * Update the profile (name + photo url) of the authenticated ngx-auth-firebaseui-user in the
     * firebase authentication feature (not in firestore)
     *
     * @param name - the new name of the authenticated ngx-auth-firebaseui-user
     * @param photoURL - the new photo url of the authenticated ngx-auth-firebaseui-user
     * @returns -
     */
    AuthProcessService.prototype.updateProfile = function (name, photoURL) {
        if (!photoURL) {
            return this.user.updateProfile({ displayName: name });
        }
        else {
            return this.user.updateProfile({ displayName: name, photoURL: photoURL });
        }
    };
    AuthProcessService.prototype.parseUserInfo = function (user) {
        return {
            uid: user.uid,
            displayName: user.displayName,
            email: user.email,
            phoneNumber: user.phoneNumber,
            photoURL: user.photoURL,
            providerId: user.providerData.length > 0 ? user.providerData[0].providerId : null
        };
    };
    AuthProcessService.prototype.getUserPhotoUrl = function () {
        var user = this.user;
        if (!user) {
            return;
        }
        else if (user.photoURL) {
            return user.photoURL;
        }
        else if (user.emailVerified) {
            return this.getPhotoPath(Accounts.CHECK);
        }
        else if (user.isAnonymous) {
            return this.getPhotoPath(Accounts.OFF);
        }
        else {
            return this.getPhotoPath(Accounts.NONE);
        }
    };
    AuthProcessService.prototype.getPhotoPath = function (image) {
        return "assets/user/" + image + ".svg";
    };
    AuthProcessService.prototype.signInWithPhoneNumber = function () {
        // todo: 3.1.18
    };
    AuthProcessService.prototype.handleSuccess = function (userCredential) {
        return __awaiter(this, void 0, void 0, function () {
            var e_1, fallbackMessage;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        this.onSuccessEmitter.next(userCredential.user);
                        if (!this.config.enableFirestoreSync) return [3 /*break*/, 4];
                        _a.label = 1;
                    case 1:
                        _a.trys.push([1, 3, , 4]);
                        return [4 /*yield*/, this.fireStoreService.updateUserData(this.parseUserInfo(userCredential.user))];
                    case 2:
                        _a.sent();
                        return [3 /*break*/, 4];
                    case 3:
                        e_1 = _a.sent();
                        console.error("Error occurred while updating user data with firestore: " + e_1);
                        return [3 /*break*/, 4];
                    case 4:
                        if (this.config.toastMessageOnAuthSuccess) {
                            fallbackMessage = "Hello " + (userCredential.user.displayName ? userCredential.user.displayName : '') + "!";
                            this.showToast(this.messageOnAuthSuccess || fallbackMessage);
                        }
                        return [2 /*return*/];
                }
            });
        });
    };
    AuthProcessService.prototype.handleError = function (error) {
        this.notifyError(error);
        console.error(error);
    };
    // Refresh user info. Can be useful for instance to get latest status regarding email verification.
    AuthProcessService.prototype.reloadUserInfo = function () {
        return this.user.reload();
    };
    // Search for an error message.
    // Consumers of this library are given the possibility to provide a
    // function in case they want to instrument message based on error properties.
    AuthProcessService.prototype.getMessageOnAuthError = function (error) {
        // tslint:disable-next-line:no-bitwise
        return error.toString() || 'Sorry, something went wrong. Please retry later.';
    };
    // Show a toast using current snackbar config. If message is empty, no toast is displayed allowing to opt-out when needed.
    // Default MatSnackBarConfig has no duration, meaning it stays visible forever.
    // If that's the case, an action button is added to allow the end-user to dismiss the toast.
    AuthProcessService.prototype.showToast = function (message) {
        if (message) {
            this.snackBar.open(message, this.matSnackBarConfig.duration ? null : 'OK');
        }
    };
    AuthProcessService.prototype.showErrorToast = function (error) {
        if (this.config.toastMessageOnAuthError) {
            this.showToast(this.getMessageOnAuthError(error));
        }
    };
    AuthProcessService.prototype.notifyError = function (error) {
        this.onErrorEmitter.emit(error);
        this.showErrorToast(error);
    };
    AuthProcessService.ctorParameters = function () { return [
        { type: AngularFireAuth },
        { type: undefined, decorators: [{ type: Inject, args: [forwardRef(function () { return NgxAuthFirebaseUIConfigToken; }),] }] },
        { type: MatSnackBar },
        { type: FirestoreSyncService },
        { type: MatSnackBarConfig, decorators: [{ type: Inject, args: [MAT_SNACK_BAR_DEFAULT_OPTIONS,] }] }
    ]; };
    AuthProcessService.ɵprov = i0.ɵɵdefineInjectable({ factory: function AuthProcessService_Factory() { return new AuthProcessService(i0.ɵɵinject(i1.AngularFireAuth), i0.ɵɵinject(i2.NgxAuthFirebaseUIConfigToken), i0.ɵɵinject(i3.MatSnackBar), i0.ɵɵinject(i4.FirestoreSyncService), i0.ɵɵinject(i3.MAT_SNACK_BAR_DEFAULT_OPTIONS)); }, token: AuthProcessService, providedIn: "root" });
    AuthProcessService = __decorate([
        Injectable({
            providedIn: 'root'
        }),
        __param(1, Inject(forwardRef(function () { return NgxAuthFirebaseUIConfigToken; }))),
        __param(4, Inject(MAT_SNACK_BAR_DEFAULT_OPTIONS))
    ], AuthProcessService);
    return AuthProcessService;
}());
export { AuthProcessService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC1wcm9jZXNzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtYXV0aC1maXJlYmFzZXVpLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL2F1dGgtcHJvY2Vzcy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUMsWUFBWSxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQzNFLE9BQU8sRUFBQyxlQUFlLEVBQUMsTUFBTSxvQkFBb0IsQ0FBQztBQUNuRCxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ3ZDLE9BQU8sZ0JBQWdCLENBQUM7QUFHeEIsT0FBTyxFQUFDLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ25DLE9BQU8sRUFBQyxRQUFRLEVBQUMsTUFBTSxVQUFVLENBQUM7QUFDbEMsT0FBTyxFQUFDLG9CQUFvQixFQUFDLE1BQU0sMEJBQTBCLENBQUM7QUFDOUQsT0FBTyxFQUFDLDZCQUE2QixFQUFFLFdBQVcsRUFBRSxpQkFBaUIsRUFBQyxNQUFNLDZCQUE2QixDQUFDO0FBRTFHLE9BQU8sRUFBQyw0QkFBNEIsRUFBQyxNQUFNLFdBQVcsQ0FBQzs7Ozs7O0FBTXZELE1BQU0sQ0FBQyxJQUFNLG9CQUFvQixHQUFHLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO0FBQzdFLE1BQU0sQ0FBQyxJQUFNLGtCQUFrQixHQUFHLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO0FBQ3pFLE1BQU0sQ0FBQyxJQUFNLGlCQUFpQixHQUFHLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDOUUsTUFBTSxDQUFDLElBQU0sbUJBQW1CLEdBQUcsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7QUFDM0UsTUFB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RUFBRTtZQUNYLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQzVFO0lBQ0gsQ0FBQztJQUVELDJDQUFjLEdBQWQsVUFBZSxLQUFVO1FBQ3ZCLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyx1QkFBdUIsRUFBRTtZQUN2QyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1NBQ25EO0lBQ0gsQ0FBQztJQUVELHdDQUFXLEdBQVgsVUFBWSxLQUFVO1FBQ3BCLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2hDLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDN0IsQ0FBQzs7Z0JBelBhLGVBQWU7Z0RBQzFCLE1BQU0sU0FBQyxVQUFVLENBQUMsY0FBTSxPQUFBLDRCQUE0QixFQUE1QixDQUE0QixDQUFDO2dCQUNwQyxXQUFXO2dCQUNILG9CQUFvQjtnQkFDb0IsaUJBQWlCLHVCQUFsRixNQUFNLFNBQUMsNkJBQTZCOzs7SUF2QjVCLGtCQUFrQjtRQUg5QixVQUFVLENBQUM7WUFDVixVQUFVLEVBQUUsTUFBTTtTQUNuQixDQUFDO1FBcUJHLFdBQUEsTUFBTSxDQUFDLFVBQVUsQ0FBQyxjQUFNLE9BQUEsNEJBQTRCLEVBQTVCLENBQTRCLENBQUMsQ0FBQyxDQUFBO1FBR3RELFdBQUEsTUFBTSxDQUFDLDZCQUE2QixDQUFDLENBQUE7T0F2QjdCLGtCQUFrQixDQThROUI7NkJBeFREO0NBd1RDLEFBOVFELElBOFFDO1NBOVFZLGtCQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RXZlbnRFbWl0dGVyLCBmb3J3YXJkUmVmLCBJbmplY3QsIEluamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtBbmd1bGFyRmlyZUF1dGh9IGZyb20gJ0Bhbmd1bGFyL2ZpcmUvYXV0aCc7XG5pbXBvcnQge2ZpcmViYXNlfSBmcm9tICdAZmlyZWJhc2UvYXBwJztcbmltcG9ydCAnQGZpcmViYXNlL2F1dGgnO1xuaW1wb3J0IHtVc2VyLCBVc2VySW5mb30gZnJvbSAnZmlyZWJhc2UvYXBwJztcbmltcG9ydCB7T2JzZXJ2YWJsZX0gZnJvbSAncnhqcyc7XG5pbXBvcnQge3RhcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtBY2NvdW50c30gZnJvbSAnLi4vZW51bXMnO1xuaW1wb3J0IHtGaXJlc3RvcmVTeW5jU2VydmljZX0gZnJvbSAnLi9maXJlc3RvcmUtc3luYy5zZXJ2aWNlJztcbmltcG9ydCB7TUFUX1NOQUNLX0JBUl9ERUZBVUxUX09QVElPTlMsIE1hdFNuYWNrQmFyLCBNYXRTbmFja0JhckNvbmZpZ30gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvc25hY2stYmFyJztcbmltcG9ydCB7SUNyZWRlbnRpYWxzLCBJU2lnbkluUHJvY2VzcywgSVNpZ25VcFByb2Nlc3MsIE5neEF1dGhGaXJlYmFzZVVJQ29uZmlnfSBmcm9tICcuLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7Tmd4QXV0aEZpcmViYXNlVUlDb25maWdUb2tlbn0gZnJvbSAnLi4vdG9rZW5zJztcblxuLy8gaW1wb3J0IFVzZXIgPSBmaXJlYmFzZS5Vc2VyO1xuXG5pbXBvcnQgVXNlckNyZWRlbnRpYWwgPSBmaXJlYmFzZS5hdXRoLlVzZXJDcmVkZW50aWFsO1xuXG5leHBvcnQgY29uc3QgZmFjZWJvb2tBdXRoUHJvdmlkZXIgPSBuZXcgZmlyZWJhc2UuYXV0aC5GYWNlYm9va0F1dGhQcm92aWRlcigpO1xuZXhwb3J0IGNvbnN0IGdvb2dsZUF1dGhQcm92aWRlciA9IG5ldyBmaXJlYmFzZS5hdXRoLkdvb2dsZUF1dGhQcm92aWRlcigpO1xuZXhwb3J0IGNvbnN0IGFwcGxlQXV0aFByb3ZpZGVyID0gbmV3IGZpcmViYXNlLmF1dGguT0F1dGhQcm92aWRlcignYXBwbGUuY29tJyk7XG5leHBvcnQgY29uc3QgdHdpdHRlckF1dGhQcm92aWRlciA9IG5ldyBmaXJlYmFzZS5hdXRoLlR3aXR0ZXJBdXRoUHJvdmlkZXIoKTtcbmV4cG9ydCBjb25zdCBnaXRodWJBdXRoUHJvdmlkZXIgPSBuZXcgZmlyZWJhc2UuYXV0aC5HaXRodWJBdXRoUHJvdmlkZXIoKTtcbmV4cG9ydCBjb25zdCBtaWNyb3NvZnRBdXRoUHJvdmlkZXIgPSBuZXcgZmlyZWJhc2UuYXV0aC5PQXV0aFByb3ZpZGVyKCdtaWNyb3NvZnQuY29tJyk7XG5leHBvcnQgY29uc3QgeWFob29BdXRoUHJvdmlkZXIgPSBuZXcgZmlyZWJhc2UuYXV0aC5PQXV0aFByb3ZpZGVyKCd5YWhvby5jb20nKTtcblxuZXhwb3J0IGVudW0gQXV0aFByb3ZpZGVyIHtcbiAgQUxMID0gJ2FsbCcsXG4gIEFOT05ZTU9VUyA9ICdhbm9ueW1vdXMnLFxuICBFbWFpbEFuZFBhc3N3b3JkID0gJ2ZpcmViYXNlJyxcbiAgR29vZ2xlID0gJ2dvb2dsZScsXG4gIEFwcGxlID0gJ0FwcGxlJyxcbiAgRmFjZWJvb2sgPSAnZmFjZWJvb2snLFxuICBUd2l0dGVyID0gJ3R3aXR0ZXInLFxuICBHaXRodWIgPSAnZ2l0aHViJyxcbiAgTWljcm9zb2Z0ID0gJ21pY3Jvc29mdCcsXG4gIFlhaG9vID0gJ3lhaG9vJyxcbiAgUGhvbmVOdW1iZXIgPSAncGhvbmVOdW1iZXInXG59XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIEF1dGhQcm9jZXNzU2VydmljZSBpbXBsZW1lbnRzIElTaWduSW5Qcm9jZXNzLCBJU2lnblVwUHJvY2VzcyB7XG4gIG9uU3VjY2Vzc0VtaXR0ZXI6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIG9uRXJyb3JFbWl0dGVyOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIC8vIFVzZWZ1bCB0byBrbm93IGF1Ym91dCBhdXRoIHN0YXRlIGV2ZW4gYmV0d2VlbiByZWxvYWRzLlxuICAvLyBSZXBsYWNlIGVtYWlsQ29uZmlybWF0aW9uU2VudCBhbmQgZW1haWxUb0NvbmZpcm0uXG4gIHVzZXIkOiBPYnNlcnZhYmxlPFVzZXI+O1xuICB1c2VyOiBVc2VyO1xuXG4gIG1lc3NhZ2VPbkF1dGhTdWNjZXNzOiBzdHJpbmc7XG4gIG1lc3NhZ2VPbkF1dGhFcnJvcjogc3RyaW5nO1xuXG4gIC8vIExlZ2FjeSBmaWVsZCB0aGF0IGlzIHNldHRlZCB0byB0cnVlIGFmdGVyIHNpZ24gdXAuXG4gIC8vIFZhbHVlIGlzIGxvc3QgaW4gY2FzZSBvZiByZWxvYWQuIFRoZSBpZGVhIGhlcmUgaXMgdG8ga25vdyBpZiB3ZSBqdXN0IHNlbnQgYSB2ZXJpZmljYXRpb24gZW1haWwuXG4gIGVtYWlsQ29uZmlybWF0aW9uU2VudDogYm9vbGVhbjtcbiAgLy8gTGVmYWN5IGZpbGVkIHRoYXQgY29udGFpbiB0aGUgbWFpbCB0byBjb25maXJtLiBTYW1lIGxpZmVjeWxlIHRoYW4gZW1haWxDb25maXJtYXRpb25TZW50LlxuICBlbWFpbFRvQ29uZmlybTogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBhZmE6IEFuZ3VsYXJGaXJlQXV0aCxcbiAgICBASW5qZWN0KGZvcndhcmRSZWYoKCkgPT4gTmd4QXV0aEZpcmViYXNlVUlDb25maWdUb2tlbikpIHB1YmxpYyBjb25maWc6IE5neEF1dGhGaXJlYmFzZVVJQ29uZmlnLFxuICAgIHByaXZhdGUgc25hY2tCYXI6IE1hdFNuYWNrQmFyLFxuICAgIHByaXZhdGUgZmlyZVN0b3JlU2VydmljZTogRmlyZXN0b3JlU3luY1NlcnZpY2UsXG4gICAgQEluamVjdChNQVRfU05BQ0tfQkFSX0RFRkFVTFRfT1BUSU9OUykgcHJpdmF0ZSBtYXRTbmFja0JhckNvbmZpZzogTWF0U25hY2tCYXJDb25maWdcbiAgKSB7XG4gIH1cblxuICBsaXN0ZW5Ub1VzZXJFdmVudHMoKSB7XG4gICAgdGhpcy51c2VyJCA9IHRoaXMuYWZhLnVzZXIucGlwZShcbiAgICAgIHRhcCh1c2VyID0+IHtcbiAgICAgICAgdGhpcy51c2VyID0gdXNlcjtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXNldCB0aGUgcGFzc3dvcmQgb2YgdGhlIG5neC1hdXRoLWZpcmViYXNldWktdXNlciB2aWEgZW1haWxcbiAgICpcbiAgICogQHBhcmFtIGVtYWlsIC0gdGhlIGVtYWlsIHRvIHJlc2V0XG4gICAqL1xuICBwdWJsaWMgYXN5bmMgcmVzZXRQYXNzd29yZChlbWFpbDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnNvbGUubG9nKCdQYXNzd29yZCByZXNldCBlbWFpbCBzZW50Jyk7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5hZmEuc2VuZFBhc3N3b3JkUmVzZXRFbWFpbChlbWFpbCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiB0aGlzLm5vdGlmeUVycm9yKGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhbCBzaWduIGluIG1lY2hhbmlzbSB0byBhdXRoZW50aWNhdGUgdGhlIHVzZXJzIHdpdGggYSBmaXJlYmFzZSBwcm9qZWN0XG4gICAqIHVzaW5nIGEgdHJhZGl0aW9uYWwgd2F5LCB2aWEgdXNlcm5hbWUgYW5kIHBhc3N3b3JkIG9yIGJ5IHVzaW5nIGFuIGF1dGhlbnRpY2F0aW9uIHByb3ZpZGVyXG4gICAqIGxpa2UgZ29vZ2xlLCBmYWNlYm9vaywgdHdpdHRlciBhbmQgZ2l0aHViXG4gICAqXG4gICAqIEBwYXJhbSBwcm92aWRlciAtIHRoZSBwcm92aWRlciB0byBhdXRoZW50aWNhdGUgd2l0aCAoZ29vZ2xlLCBmYWNlYm9vaywgdHdpdHRlciwgZ2l0aHViKVxuICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXJlZHVuZGFudC1qc2RvY1xuICAgKiBAcGFyYW0gY3JlZGVudGlhbHNcbiAgICovXG4gIHB1YmxpYyBhc3luYyBzaWduSW5XaXRoKHByb3ZpZGVyOiBBdXRoUHJvdmlkZXIsIGNyZWRlbnRpYWxzPzogSUNyZWRlbnRpYWxzKSB7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBzaWduSW5SZXN1bHQ6IFVzZXJDcmVkZW50aWFsIHwgYW55O1xuXG4gICAgICBzd2l0Y2ggKHByb3ZpZGVyKSB7XG4gICAgICAgIGNhc2UgQXV0aFByb3ZpZGVyLkFOT05ZTU9VUzpcbiAgICAgICAgICBzaWduSW5SZXN1bHQgPSBhd2FpdCB0aGlzLmFmYS5zaWduSW5Bbm9ueW1vdXNseSgpIGFzIFVzZXJDcmVkZW50aWFsO1xuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgQXV0aFByb3ZpZGVyLkVtYWlsQW5kUGFzc3dvcmQ6XG4gICAgICAgICAgc2lnbkluUmVzdWx0ID0gYXdhaXQgdGhpcy5hZmEuc2lnbkluV2l0aEVtYWlsQW5kUGFzc3dvcmQoY3JlZGVudGlhbHMuZW1haWwsIGNyZWRlbnRpYWxzLnBhc3N3b3JkKSBhcyBVc2VyQ3JlZGVudGlhbDtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIEF1dGhQcm92aWRlci5Hb29nbGU6XG4gICAgICAgICAgc2lnbkluUmVzdWx0ID0gYXdhaXQgdGhpcy5hZmEuc2lnbkluV2l0aFBvcHVwKGdvb2dsZUF1dGhQcm92aWRlcikgYXMgVXNlckNyZWRlbnRpYWw7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSBBdXRoUHJvdmlkZXIuQXBwbGU6XG4gICAgICAgICAgc2lnbkluUmVzdWx0ID0gYXdhaXQgdGhpcy5hZmEuc2lnbkluV2l0aFBvcHVwKGFwcGxlQXV0aFByb3ZpZGVyKSBhcyBVc2VyQ3JlZGVudGlhbDtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIEF1dGhQcm92aWRlci5GYWNlYm9vazpcbiAgICAgICAgICBzaWduSW5SZXN1bHQgPSBhd2FpdCB0aGlzLmFmYS5zaWduSW5XaXRoUG9wdXAoZmFjZWJvb2tBdXRoUHJvdmlkZXIpIGFzIFVzZXJDcmVkZW50aWFsO1xuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgQXV0aFByb3ZpZGVyLlR3aXR0ZXI6XG4gICAgICAgICAgc2lnbkluUmVzdWx0ID0gYXdhaXQgdGhpcy5hZmEuc2lnbkluV2l0aFBvcHVwKHR3aXR0ZXJBdXRoUHJvdmlkZXIpIGFzIFVzZXJDcmVkZW50aWFsO1xuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgQXV0aFByb3ZpZGVyLkdpdGh1YjpcbiAgICAgICAgICBzaWduSW5SZXN1bHQgPSBhd2FpdCB0aGlzLmFmYS5zaWduSW5XaXRoUG9wdXAoZ2l0aHViQXV0aFByb3ZpZGVyKSBhcyBVc2VyQ3JlZGVudGlhbDtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIEF1dGhQcm92aWRlci5NaWNyb3NvZnQ6XG4gICAgICAgICAgc2lnbkluUmVzdWx0ID0gYXdhaXQgdGhpcy5hZmEuc2lnbkluV2l0aFBvcHVwKG1pY3Jvc29mdEF1dGhQcm92aWRlcikgYXMgVXNlckNyZWRlbnRpYWw7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSBBdXRoUHJvdmlkZXIuWWFob286XG4gICAgICAgICAgc2lnbkluUmVzdWx0ID0gYXdhaXQgdGhpcy5hZmEuc2lnbkluV2l0aFBvcHVwKHlhaG9vQXV0aFByb3ZpZGVyKSBhcyBVc2VyQ3JlZGVudGlhbDtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIEF1dGhQcm92aWRlci5QaG9uZU51bWJlcjpcbiAgICAgICAgICAvLyBjb21pbmcgc29vbiAtIHNlZSBmZWF0dXJlL3NtcyBicmFuY2hcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgJHtBdXRoUHJvdmlkZXJbcHJvdmlkZXJdfSBpcyBub3QgYXZhaWxhYmxlIGFzIGF1dGggcHJvdmlkZXJgKTtcbiAgICAgIH1cbiAgICAgIGF3YWl0IHRoaXMuaGFuZGxlU3VjY2VzcyhzaWduSW5SZXN1bHQpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhpcy5oYW5kbGVFcnJvcihlcnIpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTaWduIHVwIG5ldyB1c2VycyB2aWEgZW1haWwgYW5kIHBhc3N3b3JkLlxuICAgKiBBZnRlciB0aGF0IHRoZSBuZ3gtYXV0aC1maXJlYmFzZXVpLXVzZXIgc2hvdWxkIHZlcmlmeSBhbmQgY29uZmlybSBhbiBlbWFpbCBzZW50IHZpYSB0aGUgZmlyZWJhc2VcbiAgICpcbiAgICogQHBhcmFtIGRpc3BsYXlOYW1lIC0gdGhlIGRpc3BsYXlOYW1lIGlmIHRoZSBuZXcgbmd4LWF1dGgtZmlyZWJhc2V1aS11c2VyXG4gICAqIEByZXR1cm5zIC1cbiAgICovXG4gIHB1YmxpYyBhc3luYyBzaWduVXAoZGlzcGxheU5hbWU6IHN0cmluZywgY3JlZGVudGlhbHM6IElDcmVkZW50aWFscykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB1c2VyQ3JlZGVudGlhbDogVXNlckNyZWRlbnRpYWwgPSBhd2FpdCB0aGlzLmFmYS5jcmVhdGVVc2VyV2l0aEVtYWlsQW5kUGFzc3dvcmQoY3JlZGVudGlhbHMuZW1haWwsIGNyZWRlbnRpYWxzLnBhc3N3b3JkKTtcbiAgICAgIGNvbnN0IHVzZXIgPSB1c2VyQ3JlZGVudGlhbC51c2VyO1xuICAgICAgYXdhaXQgdGhpcy51cGRhdGVQcm9maWxlKGRpc3BsYXlOYW1lLCB1c2VyLnBob3RvVVJMKTtcblxuICAgICAgaWYgKHRoaXMuY29uZmlnLmVuYWJsZUZpcmVzdG9yZVN5bmMpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5maXJlU3RvcmVTZXJ2aWNlXG4gICAgICAgICAgLmdldFVzZXJEb2NSZWZCeVVJRCh1c2VyLnVpZClcbiAgICAgICAgICAuc2V0KHtcbiAgICAgICAgICAgIHVpZDogdXNlci51aWQsXG4gICAgICAgICAgICBkaXNwbGF5TmFtZSxcbiAgICAgICAgICAgIGVtYWlsOiB1c2VyLmVtYWlsLFxuICAgICAgICAgICAgcGhvdG9VUkw6IHVzZXIucGhvdG9VUkxcbiAgICAgICAgICB9IGFzIFVzZXIpO1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5jb25maWcuZW5hYmxlRW1haWxWZXJpZmljYXRpb24pIHtcbiAgICAgICAgYXdhaXQgdXNlci5zZW5kRW1haWxWZXJpZmljYXRpb24oKTtcbiAgICAgIH1cblxuICAgICAgLy8gTGVnYWN5IGZpZWxkc1xuICAgICAgdGhpcy5lbWFpbENvbmZpcm1hdGlvblNlbnQgPSB0cnVlO1xuICAgICAgdGhpcy5lbWFpbFRvQ29uZmlybSA9IGNyZWRlbnRpYWxzLmVtYWlsO1xuXG4gICAgICBhd2FpdCB0aGlzLmhhbmRsZVN1Y2Nlc3ModXNlckNyZWRlbnRpYWwpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhpcy5oYW5kbGVFcnJvcihlcnIpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHNlbmROZXdWZXJpZmljYXRpb25FbWFpbCgpIHtcbiAgICBpZiAoIXRoaXMudXNlcikge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcignTm8gc2lnbmVkIGluIHVzZXInKSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnVzZXIuc2VuZEVtYWlsVmVyaWZpY2F0aW9uKCk7XG4gIH1cblxuICBhc3luYyBzaWduT3V0KCkge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmFmYS5zaWduT3V0KCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubm90aWZ5RXJyb3IoZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGUgdGhlIHByb2ZpbGUgKG5hbWUgKyBwaG90byB1cmwpIG9mIHRoZSBhdXRoZW50aWNhdGVkIG5neC1hdXRoLWZpcmViYXNldWktdXNlciBpbiB0aGVcbiAgICogZmlyZWJhc2UgYXV0aGVudGljYXRpb24gZmVhdHVyZSAobm90IGluIGZpcmVzdG9yZSlcbiAgICpcbiAgICogQHBhcmFtIG5hbWUgLSB0aGUgbmV3IG5hbWUgb2YgdGhlIGF1dGhlbnRpY2F0ZWQgbmd4LWF1dGgtZmlyZWJhc2V1aS11c2VyXG4gICAqIEBwYXJhbSBwaG90b1VSTCAtIHRoZSBuZXcgcGhvdG8gdXJsIG9mIHRoZSBhdXRoZW50aWNhdGVkIG5neC1hdXRoLWZpcmViYXNldWktdXNlclxuICAgKiBAcmV0dXJucyAtXG4gICAqL1xuICBwdWJsaWMgdXBkYXRlUHJvZmlsZShuYW1lOiBzdHJpbmcsIHBob3RvVVJMOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIXBob3RvVVJMKSB7XG4gICAgICByZXR1cm4gdGhpcy51c2VyLnVwZGF0ZVByb2ZpbGUoe2Rpc3BsYXlOYW1lOiBuYW1lfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLnVzZXIudXBkYXRlUHJvZmlsZSh7ZGlzcGxheU5hbWU6IG5hbWUsIHBob3RvVVJMfSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHBhcnNlVXNlckluZm8odXNlcjogVXNlcik6IFVzZXJJbmZvIHtcbiAgICByZXR1cm4ge1xuICAgICAgdWlkOiB1c2VyLnVpZCxcbiAgICAgIGRpc3BsYXlOYW1lOiB1c2VyLmRpc3BsYXlOYW1lLFxuICAgICAgZW1haWw6IHVzZXIuZW1haWwsXG4gICAgICBwaG9uZU51bWJlcjogdXNlci5waG9uZU51bWJlcixcbiAgICAgIHBob3RvVVJMOiB1c2VyLnBob3RvVVJMLFxuICAgICAgcHJvdmlkZXJJZDogdXNlci5wcm92aWRlckRhdGEubGVuZ3RoID4gMCA/IHVzZXIucHJvdmlkZXJEYXRhWzBdLnByb3ZpZGVySWQgOiBudWxsXG4gICAgfTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRVc2VyUGhvdG9VcmwoKTogc3RyaW5nIHtcblxuICAgIGNvbnN0IHVzZXI6IGZpcmViYXNlLlVzZXIgfCBudWxsID0gdGhpcy51c2VyO1xuXG4gICAgaWYgKCF1c2VyKSB7XG4gICAgICByZXR1cm47XG4gICAgfSBlbHNlIGlmICh1c2VyLnBob3RvVVJMKSB7XG4gICAgICByZXR1cm4gdXNlci5waG90b1VSTDtcbiAgICB9IGVsc2UgaWYgKHVzZXIuZW1haWxWZXJpZmllZCkge1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0UGhvdG9QYXRoKEFjY291bnRzLkNIRUNLKTtcbiAgICB9IGVsc2UgaWYgKHVzZXIuaXNBbm9ueW1vdXMpIHtcbiAgICAgIHJldHVybiB0aGlzLmdldFBob3RvUGF0aChBY2NvdW50cy5PRkYpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5nZXRQaG90b1BhdGgoQWNjb3VudHMuTk9ORSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldFBob3RvUGF0aChpbWFnZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIGBhc3NldHMvdXNlci8ke2ltYWdlfS5zdmdgO1xuICB9XG5cbiAgcHVibGljIHNpZ25JbldpdGhQaG9uZU51bWJlcigpIHtcbiAgICAvLyB0b2RvOiAzLjEuMThcbiAgfVxuXG4gIGFzeW5jIGhhbmRsZVN1Y2Nlc3ModXNlckNyZWRlbnRpYWw6IFVzZXJDcmVkZW50aWFsKSB7XG4gICAgdGhpcy5vblN1Y2Nlc3NFbWl0dGVyLm5leHQodXNlckNyZWRlbnRpYWwudXNlcik7XG4gICAgaWYgKHRoaXMuY29uZmlnLmVuYWJsZUZpcmVzdG9yZVN5bmMpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMuZmlyZVN0b3JlU2VydmljZS51cGRhdGVVc2VyRGF0YSh0aGlzLnBhcnNlVXNlckluZm8odXNlckNyZWRlbnRpYWwudXNlcikpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLmVycm9yKGBFcnJvciBvY2N1cnJlZCB3aGlsZSB1cGRhdGluZyB1c2VyIGRhdGEgd2l0aCBmaXJlc3RvcmU6ICR7ZX1gKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMuY29uZmlnLnRvYXN0TWVzc2FnZU9uQXV0aFN1Y2Nlc3MpIHtcbiAgICAgIGNvbnN0IGZhbGxiYWNrTWVzc2FnZSA9IGBIZWxsbyAke3VzZXJDcmVkZW50aWFsLnVzZXIuZGlzcGxheU5hbWUgPyB1c2VyQ3JlZGVudGlhbC51c2VyLmRpc3BsYXlOYW1lIDogJyd9IWA7XG4gICAgICB0aGlzLnNob3dUb2FzdCh0aGlzLm1lc3NhZ2VPbkF1dGhTdWNjZXNzIHx8IGZhbGxiYWNrTWVzc2FnZSk7XG4gICAgfVxuICB9XG5cbiAgaGFuZGxlRXJyb3IoZXJyb3I6IGFueSkge1xuICAgIHRoaXMubm90aWZ5RXJyb3IoZXJyb3IpO1xuICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICB9XG5cbiAgLy8gUmVmcmVzaCB1c2VyIGluZm8uIENhbiBiZSB1c2VmdWwgZm9yIGluc3RhbmNlIHRvIGdldCBsYXRlc3Qgc3RhdHVzIHJlZ2FyZGluZyBlbWFpbCB2ZXJpZmljYXRpb24uXG4gIHJlbG9hZFVzZXJJbmZvKCkge1xuICAgIHJldHVybiB0aGlzLnVzZXIucmVsb2FkKCk7XG4gIH1cblxuICAvLyBTZWFyY2ggZm9yIGFuIGVycm9yIG1lc3NhZ2UuXG4gIC8vIENvbnN1bWVycyBvZiB0aGlzIGxpYnJhcnkgYXJlIGdpdmVuIHRoZSBwb3NzaWJpbGl0eSB0byBwcm92aWRlIGFcbiAgLy8gZnVuY3Rpb24gaW4gY2FzZSB0aGV5IHdhbnQgdG8gaW5zdHJ1bWVudCBtZXNzYWdlIGJhc2VkIG9uIGVycm9yIHByb3BlcnRpZXMuXG4gIGdldE1lc3NhZ2VPbkF1dGhFcnJvcihlcnJvcjogYW55KSB7XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWJpdHdpc2VcbiAgICByZXR1cm4gZXJyb3IudG9TdHJpbmcoKSB8fCAnU29ycnksIHNvbWV0aGluZyB3ZW50IHdyb25nLiBQbGVhc2UgcmV0cnkgbGF0ZXIuJztcbiAgfVxuXG4gIC8vIFNob3cgYSB0b2FzdCB1c2luZyBjdXJyZW50IHNuYWNrYmFyIGNvbmZpZy4gSWYgbWVzc2FnZSBpcyBlbXB0eSwgbm8gdG9hc3QgaXMgZGlzcGxheWVkIGFsbG93aW5nIHRvIG9wdC1vdXQgd2hlbiBuZWVkZWQuXG4gIC8vIERlZmF1bHQgTWF0U25hY2tCYXJDb25maWcgaGFzIG5vIGR1cmF0aW9uLCBtZWFuaW5nIGl0IHN0YXlzIHZpc2libGUgZm9yZXZlci5cbiAgLy8gSWYgdGhhdCdzIHRoZSBjYXNlLCBhbiBhY3Rpb24gYnV0dG9uIGlzIGFkZGVkIHRvIGFsbG93IHRoZSBlbmQtdXNlciB0byBkaXNtaXNzIHRoZSB0b2FzdC5cbiAgc2hvd1RvYXN0KG1lc3NhZ2U6IHN0cmluZykge1xuICAgIGlmIChtZXNzYWdlKSB7XG4gICAgICB0aGlzLnNuYWNrQmFyLm9wZW4obWVzc2FnZSwgdGhpcy5tYXRTbmFja0JhckNvbmZpZy5kdXJhdGlvbiA/IG51bGwgOiAnT0snKTtcbiAgICB9XG4gIH1cblxuICBzaG93RXJyb3JUb2FzdChlcnJvcjogYW55KSB7XG4gICAgaWYgKHRoaXMuY29uZmlnLnRvYXN0TWVzc2FnZU9uQXV0aEVycm9yKSB7XG4gICAgICB0aGlzLnNob3dUb2FzdCh0aGlzLmdldE1lc3NhZ2VPbkF1dGhFcnJvcihlcnJvcikpO1xuICAgIH1cbiAgfVxuXG4gIG5vdGlmeUVycm9yKGVycm9yOiBhbnkpIHtcbiAgICB0aGlzLm9uRXJyb3JFbWl0dGVyLmVtaXQoZXJyb3IpO1xuICAgIHRoaXMuc2hvd0Vycm9yVG9hc3QoZXJyb3IpO1xuICB9XG5cbn1cbiJdfQ==