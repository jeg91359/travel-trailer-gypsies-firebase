import { __awaiter, __decorate, __generator, __param } from "tslib";
import { Component, EventEmitter, forwardRef, Inject, Input, Output } from '@angular/core';
import { AngularFireAuth } from '@angular/fire/auth';
import { FormControl, FormGroup, Validators } from '@angular/forms';
import { EMAIL_REGEX, PHONE_NUMBER_REGEX } from '..';
import { NgxAuthFirebaseUIConfigToken } from '../../tokens';
import { AuthProcessService } from '../../services/auth-process.service';
import { FirestoreSyncService } from '../../services/firestore-sync.service';
var UserComponent = /** @class */ (function () {
    function UserComponent(auth, authProcess, fireStoreService, config) {
        this.auth = auth;
        this.authProcess = authProcess;
        this.fireStoreService = fireStoreService;
        this.config = config;
        this.canLogout = true;
        this.canEditAccount = true;
        this.canDeleteAccount = true;
        // tslint:disable-next-line:no-output-on-prefix
        this.onSignOut = new EventEmitter();
        // tslint:disable-next-line:no-output-on-prefix
        this.onAccountEdited = new EventEmitter();
        // tslint:disable-next-line:no-output-on-prefix
        this.onAccountDeleted = new EventEmitter();
    }
    UserComponent.prototype.changeEditMode = function () {
        this.editMode = !this.editMode;
        this.editMode ? this.initUpdateFormGroup() : this.reset();
    };
    UserComponent.prototype.reset = function () {
        this.updateFormGroup.reset();
        this.updateFormGroup.disable();
        this.updateFormGroup = null;
    };
    UserComponent.prototype.save = function () {
        return __awaiter(this, void 0, void 0, function () {
            var user, snackBarMsg, error_1;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (!this.updateFormGroup.dirty) return [3 /*break*/, 12];
                        user = this.authProcess.user;
                        snackBarMsg = [];
                        _a.label = 1;
                    case 1:
                        _a.trys.push([1, 10, , 11]);
                        if (!this.updateNameFormControl.dirty) return [3 /*break*/, 3];
                        return [4 /*yield*/, user.updateProfile({ displayName: this.updateNameFormControl.value })];
                    case 2:
                        _a.sent();
                        snackBarMsg.push("your name has been updated to " + user.displayName);
                        _a.label = 3;
                    case 3:
                        if (!this.updateEmailFormControl.dirty) return [3 /*break*/, 5];
                        return [4 /*yield*/, user.updateEmail(this.updateEmailFormControl.value)];
                    case 4:
                        _a.sent();
                        snackBarMsg.push("your email has been updated to " + user.email);
                        _a.label = 5;
                    case 5:
                        if (!this.updatePhoneNumberFormControl.dirty) return [3 /*break*/, 7];
                        return [4 /*yield*/, user.updatePhoneNumber(this.updatePhoneNumberFormControl.value)];
                    case 6:
                        _a.sent();
                        console.log('phone number = ', this.updatePhoneNumberFormControl.value);
                        snackBarMsg.push("your phone number has been updated to " + user.phoneNumber);
                        _a.label = 7;
                    case 7:
                        if (!this.config.enableFirestoreSync) return [3 /*break*/, 9];
                        return [4 /*yield*/, this.fireStoreService.updateUserData(this.authProcess.parseUserInfo(user))];
                    case 8:
                        _a.sent();
                        _a.label = 9;
                    case 9: return [3 /*break*/, 11];
                    case 10:
                        error_1 = _a.sent();
                        this.authProcess.showToast(error_1 && error_1.message ? error_1.message : error_1);
                        console.error(error_1);
                        return [3 /*break*/, 11];
                    case 11:
                        if (snackBarMsg.length > 0) {
                            this.authProcess.showToast(snackBarMsg.join('\\n'));
                        }
                        _a.label = 12;
                    case 12:
                        this.editMode = false;
                        return [2 /*return*/];
                }
            });
        });
    };
    UserComponent.prototype.signOut = function () {
        var _this = this;
        this.auth.signOut()
            .then(function () { return _this.onSignOut.emit(); })
            .catch(function (e) { return console.error('An error happened while signing out!', e); });
    };
    /**
     * Delete the account of the current firebase ngx-auth-firebaseui-user
     *
     * On Success, emit the <onAccountDeleted> event and toast a msg!#
     * Otherwise, log the and toast and error msg!
     *
     */
    UserComponent.prototype.deleteAccount = function () {
        return __awaiter(this, void 0, void 0, function () {
            var user, error_2;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 3, , 4]);
                        user = this.authProcess.user;
                        // await this.authProcess.deleteAccount();
                        return [4 /*yield*/, this.authProcess.user.delete()];
                    case 1:
                        // await this.authProcess.deleteAccount();
                        _a.sent();
                        // if (this.config.enableFirestoreSync) {
                        return [4 /*yield*/, this.fireStoreService.deleteUserData(user.uid)];
                    case 2:
                        // if (this.config.enableFirestoreSync) {
                        _a.sent();
                        // }
                        this.onAccountDeleted.emit();
                        this.editMode = false;
                        console.log('Your account has been successfully deleted!');
                        this.authProcess.showToast('Your account has been successfully deleted!');
                        return [3 /*break*/, 4];
                    case 3:
                        error_2 = _a.sent();
                        console.log('Error while delete user account', error_2);
                        this.authProcess.showToast("Error occurred while deleting your account: " + error_2.message);
                        return [3 /*break*/, 4];
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    UserComponent.prototype.initUpdateFormGroup = function () {
        var currentUser = this.authProcess.user;
        this.updateFormGroup = new FormGroup({
            name: this.updateNameFormControl = new FormControl({ value: currentUser.displayName, disabled: this.editMode }, [
                Validators.required,
                Validators.minLength(this.config.nameMinLength),
                Validators.maxLength(this.config.nameMaxLength)
            ]),
            email: this.updateEmailFormControl = new FormControl({ value: currentUser.email, disabled: this.editMode }, [
                Validators.required,
                Validators.pattern(EMAIL_REGEX)
            ]),
            phoneNumber: this.updatePhoneNumberFormControl = new FormControl({ value: currentUser.phoneNumber, disabled: this.editMode }, [Validators.pattern(PHONE_NUMBER_REGEX)])
        });
        this.updateFormGroup.enable();
    };
    UserComponent.ctorParameters = function () { return [
        { type: AngularFireAuth },
        { type: AuthProcessService },
        { type: FirestoreSyncService },
        { type: undefined, decorators: [{ type: Inject, args: [forwardRef(function () { return NgxAuthFirebaseUIConfigToken; }),] }] }
    ]; };
    __decorate([
        Input()
    ], UserComponent.prototype, "editMode", void 0);
    __decorate([
        Input()
    ], UserComponent.prototype, "canLogout", void 0);
    __decorate([
        Input()
    ], UserComponent.prototype, "canEditAccount", void 0);
    __decorate([
        Input()
    ], UserComponent.prototype, "canDeleteAccount", void 0);
    __decorate([
        Input()
    ], UserComponent.prototype, "appearance", void 0);
    __decorate([
        Output()
    ], UserComponent.prototype, "onSignOut", void 0);
    __decorate([
        Output()
    ], UserComponent.prototype, "onAccountEdited", void 0);
    __decorate([
        Output()
    ], UserComponent.prototype, "onAccountDeleted", void 0);
    UserComponent = __decorate([
        Component({
            selector: 'ngx-auth-firebaseui-user',
            template: "<div *ngIf=\"auth.authState| async as user; then authenticated else none\">\n\n</div>\n\n<ng-template #authenticated>\n  <mat-card *ngIf=\"auth.user | async as user\">\n    <!--<form [formGroup]=\"updateFormGroup\" >-->\n    <!--card header-->\n    <mat-card-header fxLayout=\"column\" fxLayoutAlign=\"center center\">\n\n      <img [src]=\"authProcess?.getUserPhotoUrl()\" mat-card-avatar>\n\n      <div *ngIf=\"user.emailVerified; then emailVerified else emailNotVerified\"></div>\n      <ng-template #emailVerified>\n        <mat-icon color=\"primary\"\n                  matTooltip=\"email is verified\"\n                  matTooltipPosition=\"after\">\n          verified_user\n        </mat-icon>\n      </ng-template>\n      <ng-template #emailNotVerified>\n        <mat-icon color=\"warn\"\n                  matTooltip=\"email is not verified\"\n                  matTooltipPosition=\"after\">\n          warning\n        </mat-icon>\n      </ng-template>\n\n    </mat-card-header>\n\n    <!--card content-->\n    <mat-card-content *ngIf=\"editMode; then edit else readonly\">\n    </mat-card-content>\n\n    <ng-template #edit>\n      <form (submit)=\"save()\" [formGroup]=\"updateFormGroup\">\n\n        <mat-card-content fxLayout=\"column\" fxLayoutAlign=\"center center\">\n          <div fxLayoutAlign=\"center\">\n            <button (click)=\"changeEditMode()\" class=\"edit-button\" color=\"warn\"\n                    mat-raised-button>\n              cancel\n            </button>\n          </div>\n\n          <!--name-->\n          <mat-form-field [appearance]=\"appearance\" class=\"full-width\">\n            <mat-label>Name</mat-label>\n            <input [formControl]=\"updateNameFormControl\"\n                   matInput\n                   placeholder=\"Name\">\n            <mat-icon matSuffix>person</mat-icon>\n            <mat-hint align=\"end\" aria-live=\"polite\"> {{ updateNameFormControl.value?.length }}\n              / {{ config.nameMaxLength }} </mat-hint>\n            <mat-error *ngIf=\"updateNameFormControl.hasError('required')\">\n              Name is required\n            </mat-error>\n          </mat-form-field>\n\n          <!--email-->\n          <mat-form-field [appearance]=\"appearance\" class=\"full-width\">\n            <mat-label>E-mail</mat-label>\n            <input [formControl]=\"updateEmailFormControl\"\n                   matInput\n                   placeholder=\"E-mail\">\n            <mat-icon matSuffix>email</mat-icon>\n            <mat-error *ngIf=\"updateEmailFormControl.hasError('required')\">\n              E-mail is required {{updateEmailFormControl.value}}\n            </mat-error>\n            <mat-error *ngIf=\"updateEmailFormControl.hasError('pattern')\">\n              Please enter a valid e-mail address {{updateEmailFormControl.value}}\n            </mat-error>\n          </mat-form-field>\n\n          <!--phone number-->\n          <mat-form-field *ngIf=\"false\" [appearance]=\"appearance\" class=\"full-width\">\n            <mat-label>Phone number</mat-label>\n            <input [formControl]=\"updatePhoneNumberFormControl\"\n                   matInput\n                   placeholder=\"Phone number\"\n                   type=\"tel\">\n            <mat-icon matSuffix>phone</mat-icon>\n            <mat-hint align=\"end\" aria-live=\"polite\">\n              The phone number is international. Therefore, it should start with a + sign or 00,\n              followed by the country code, - and national number e.g: +49-12345678 or 0041-1234567890\n\n              NOTE : the phone number must be a valid phone credential !!\n            </mat-hint>\n            <mat-error *ngIf=\"updatePhoneNumberFormControl.hasError('pattern')\">\n              Please enter a valid phone number\n            </mat-error>\n          </mat-form-field>\n\n        </mat-card-content>\n\n        <mat-card-actions fxLayout=\"column\">\n          <button color=\"primary\"\n                  mat-button\n                  type=\"submit\">\n            Save changes\n          </button>\n        </mat-card-actions>\n      </form>\n    </ng-template>\n\n    <ng-template #readonly>\n      <div fxLayoutAlign=\"center\">\n        <button (click)=\"changeEditMode()\" class=\"edit-button\" color=\"primary\"\n                mat-raised-button>\n          edit\n        </button>\n      </div>\n\n      <!--name-->\n      <mat-form-field [appearance]=\"appearance\" class=\"full-width\">\n        <mat-label>Name</mat-label>\n        <input [disabled]=\"!editMode\"\n               [value]=\"user.displayName\"\n               matInput\n               placeholder=\"Name\">\n        <mat-icon color=\"primary\" matSuffix>person</mat-icon>\n      </mat-form-field>\n\n      <!--email-->\n      <mat-form-field [appearance]=\"appearance\" class=\"full-width\">\n        <mat-label>E-mail</mat-label>\n        <input [disabled]=\"!editMode\"\n               [value]=\"user.email\" matInput\n               placeholder=\"E-mail\">\n        <mat-icon color=\"primary\" matSuffix>email</mat-icon>\n      </mat-form-field>\n\n      <!--phone number-->\n      <mat-form-field *ngIf=\"false\" [appearance]=\"appearance\" class=\"full-width\">\n        <mat-label>Phone number</mat-label>\n        <input [disabled]=\"!editMode\"\n               [value]=\"user.phoneNumber\"\n               matInput\n               placeholder=\"Phone number\">\n        <mat-icon color=\"primary\" matSuffix>phone</mat-icon>\n      </mat-form-field>\n\n      <mat-card-actions fxLayout=\"column\">\n        <button (click)=\"signOut()\" *ngIf=\"canLogout\" color=\"primary\" mat-button>Sign out</button>\n        <button (click)=\"deleteAccount()\" *ngIf=\"canDeleteAccount\" color=\"warn\" mat-button>Delete account</button>\n      </mat-card-actions>\n\n    </ng-template>\n\n  </mat-card>\n\n</ng-template>\n\n\n<ng-template #none>\n  <mat-card class=\"none-card\" fxLayout=\"row\" fxLayoutAlign=\"center center\">\n    <mat-card-content fxLayout=\"row\" fxLayoutAlign=\"center center\">\n      <mat-icon color=\"accent\">warning</mat-icon>\n      <span>You are not logged in!</span>\n    </mat-card-content>\n  </mat-card>\n</ng-template>\n",
            styles: [".edit-button{margin:1rem}.full-width{width:100%}.cut-text{text-overflow:ellipsis;overflow:hidden;white-space:nowrap}.none-card{min-height:430px}.none-card span{font-size:24px;text-align:center;color:rgba(0,0,0,.54)}"]
        }),
        __param(3, Inject(forwardRef(function () { return NgxAuthFirebaseUIConfigToken; })))
    ], UserComponent);
    return UserComponent;
}());
export { UserComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtYXV0aC1maXJlYmFzZXVpLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvbmd4LWF1dGgtZmlyZWJhc2V1aS11c2VyL3VzZXIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUMsU0FBUyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDekYsT0FBTyxFQUFDLGVBQWUsRUFBQyxNQUFNLG9CQUFvQixDQUFDO0FBQ25ELE9BQU8sRUFBQyxXQUFXLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBRWxFLE9BQU8sRUFBQyxXQUFXLEVBQUUsa0JBQWtCLEVBQUMsTUFBTSxJQUFJLENBQUM7QUFFbkQsT0FBTyxFQUFDLDRCQUE0QixFQUFDLE1BQU0sY0FBYyxDQUFDO0FBRTFELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3pFLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLHVDQUF1QyxDQUFDO0FBTzdFO0lBbUNFLHVCQUNTLElBQXFCLEVBQ3JCLFdBQStCLEVBQzlCLGdCQUFzQyxFQUNpQixNQUErQjtRQUh2RixTQUFJLEdBQUosSUFBSSxDQUFpQjtRQUNyQixnQkFBVyxHQUFYLFdBQVcsQ0FBb0I7UUFDOUIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFzQjtRQUNpQixXQUFNLEdBQU4sTUFBTSxDQUF5QjtRQWpDaEcsY0FBUyxHQUFHLElBQUksQ0FBQztRQUdqQixtQkFBYyxHQUFHLElBQUksQ0FBQztRQUd0QixxQkFBZ0IsR0FBRyxJQUFJLENBQUM7UUFLeEIsK0NBQStDO1FBRS9DLGNBQVMsR0FBdUIsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUVuRCwrQ0FBK0M7UUFFL0Msb0JBQWUsR0FBdUIsSUFB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RTt5REFDYztJQUd0QjtRQURDLEtBQUssRUFBRTsyREFDZ0I7SUFHeEI7UUFEQyxLQUFLLEVBQUU7cURBQzJCO0lBSW5DO1FBREMsTUFBTSxFQUFFO29EQUMwQztJQUluRDtRQURDLE1BQU0sRUFBRTswREFDZ0Q7SUFJekQ7UUFEQyxNQUFNLEVBQUU7MkRBQ2lEO0lBM0IvQyxhQUFhO1FBTHpCLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSwwQkFBMEI7WUFDcEMsbWtNQUFvQzs7U0FFckMsQ0FBQztRQXdDRyxXQUFBLE1BQU0sQ0FBQyxVQUFVLENBQUMsY0FBTSxPQUFBLDRCQUE0QixFQUE1QixDQUE0QixDQUFDLENBQUMsQ0FBQTtPQXZDOUMsYUFBYSxDQThKekI7SUFBRCxvQkFBQztDQUFBLEFBOUpELElBOEpDO1NBOUpZLGFBQWEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NvbXBvbmVudCwgRXZlbnRFbWl0dGVyLCBmb3J3YXJkUmVmLCBJbmplY3QsIElucHV0LCBPdXRwdXR9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtBbmd1bGFyRmlyZUF1dGh9IGZyb20gJ0Bhbmd1bGFyL2ZpcmUvYXV0aCc7XG5pbXBvcnQge0Zvcm1Db250cm9sLCBGb3JtR3JvdXAsIFZhbGlkYXRvcnN9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7VXNlcn0gZnJvbSAnZmlyZWJhc2UnO1xuaW1wb3J0IHtFTUFJTF9SRUdFWCwgUEhPTkVfTlVNQkVSX1JFR0VYfSBmcm9tICcuLic7XG5pbXBvcnQge01hdEZvcm1GaWVsZEFwcGVhcmFuY2V9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL2Zvcm0tZmllbGQnO1xuaW1wb3J0IHtOZ3hBdXRoRmlyZWJhc2VVSUNvbmZpZ1Rva2VufSBmcm9tICcuLi8uLi90b2tlbnMnO1xuaW1wb3J0IHtOZ3hBdXRoRmlyZWJhc2VVSUNvbmZpZ30gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBBdXRoUHJvY2Vzc1NlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9hdXRoLXByb2Nlc3Muc2VydmljZSc7XG5pbXBvcnQgeyBGaXJlc3RvcmVTeW5jU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2ZpcmVzdG9yZS1zeW5jLnNlcnZpY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICduZ3gtYXV0aC1maXJlYmFzZXVpLXVzZXInLFxuICB0ZW1wbGF0ZVVybDogJy4vdXNlci5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL3VzZXIuY29tcG9uZW50LnNjc3MnXVxufSlcbmV4cG9ydCBjbGFzcyBVc2VyQ29tcG9uZW50IHtcblxuICBASW5wdXQoKVxuICBlZGl0TW9kZTogYm9vbGVhbjtcblxuICBASW5wdXQoKVxuICBjYW5Mb2dvdXQgPSB0cnVlO1xuXG4gIEBJbnB1dCgpXG4gIGNhbkVkaXRBY2NvdW50ID0gdHJ1ZTtcblxuICBASW5wdXQoKVxuICBjYW5EZWxldGVBY2NvdW50ID0gdHJ1ZTtcblxuICBASW5wdXQoKVxuICBhcHBlYXJhbmNlOiBNYXRGb3JtRmllbGRBcHBlYXJhbmNlO1xuXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1vdXRwdXQtb24tcHJlZml4XG4gIEBPdXRwdXQoKVxuICBvblNpZ25PdXQ6IEV2ZW50RW1pdHRlcjx2b2lkPiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tb3V0cHV0LW9uLXByZWZpeFxuICBAT3V0cHV0KClcbiAgb25BY2NvdW50RWRpdGVkOiBFdmVudEVtaXR0ZXI8dm9pZD4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLW91dHB1dC1vbi1wcmVmaXhcbiAgQE91dHB1dCgpXG4gIG9uQWNjb3VudERlbGV0ZWQ6IEV2ZW50RW1pdHRlcjx2b2lkPiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICB1cGRhdGVGb3JtR3JvdXA6IEZvcm1Hcm91cDtcbiAgdXBkYXRlTmFtZUZvcm1Db250cm9sOiBGb3JtQ29udHJvbDtcbiAgdXBkYXRlRW1haWxGb3JtQ29udHJvbDogRm9ybUNvbnRyb2w7XG4gIHVwZGF0ZVBob25lTnVtYmVyRm9ybUNvbnRyb2w6IEZvcm1Db250cm9sO1xuICB1cGRhdGVQYXNzd29yZEZvcm1Db250cm9sOiBGb3JtQ29udHJvbDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgYXV0aDogQW5ndWxhckZpcmVBdXRoLFxuICAgIHB1YmxpYyBhdXRoUHJvY2VzczogQXV0aFByb2Nlc3NTZXJ2aWNlLFxuICAgIHByaXZhdGUgZmlyZVN0b3JlU2VydmljZTogRmlyZXN0b3JlU3luY1NlcnZpY2UsXG4gICAgQEluamVjdChmb3J3YXJkUmVmKCgpID0+IE5neEF1dGhGaXJlYmFzZVVJQ29uZmlnVG9rZW4pKSBwdWJsaWMgY29uZmlnOiBOZ3hBdXRoRmlyZWJhc2VVSUNvbmZpZ1xuICApIHtcbiAgfVxuXG4gIGNoYW5nZUVkaXRNb2RlKCkge1xuICAgIHRoaXMuZWRpdE1vZGUgPSAhdGhpcy5lZGl0TW9kZTtcblxuICAgIHRoaXMuZWRpdE1vZGUgPyB0aGlzLmluaXRVcGRhdGVGb3JtR3JvdXAoKSA6IHRoaXMucmVzZXQoKTtcbiAgfVxuXG4gIHJlc2V0KCkge1xuICAgIHRoaXMudXBkYXRlRm9ybUdyb3VwLnJlc2V0KCk7XG4gICAgdGhpcy51cGRhdGVGb3JtR3JvdXAuZGlzYWJsZSgpO1xuICAgIHRoaXMudXBkYXRlRm9ybUdyb3VwID0gbnVsbDtcbiAgfVxuXG4gIGFzeW5jIHNhdmUoKSB7XG4gICAgaWYgKHRoaXMudXBkYXRlRm9ybUdyb3VwLmRpcnR5KSB7XG4gICAgICBjb25zdCB1c2VyID0gdGhpcy5hdXRoUHJvY2Vzcy51c2VyO1xuICAgICAgLy8gbmd4LWF1dGgtZmlyZWJhc2V1aS11c2VyLnVwZGF0ZVByb2ZpbGUoKVxuICAgICAgLy8gbmd4LWF1dGgtZmlyZWJhc2V1aS11c2VyLnVwZGF0ZUVtYWlsKClcbiAgICAgIC8vIGNvbnNvbGUubG9nKCdmb3JtID0gJywgdGhpcy51cGRhdGVGb3JtR3JvdXApO1xuXG4gICAgICBjb25zdCBzbmFja0Jhck1zZzogc3RyaW5nW10gPSBbXTtcblxuICAgICAgdHJ5IHtcbiAgICAgICAgaWYgKHRoaXMudXBkYXRlTmFtZUZvcm1Db250cm9sLmRpcnR5KSB7XG4gICAgICAgICAgYXdhaXQgdXNlci51cGRhdGVQcm9maWxlKHtkaXNwbGF5TmFtZTogdGhpcy51cGRhdGVOYW1lRm9ybUNvbnRyb2wudmFsdWV9KTtcbiAgICAgICAgICBzbmFja0Jhck1zZy5wdXNoKGB5b3VyIG5hbWUgaGFzIGJlZW4gdXBkYXRlZCB0byAke3VzZXIuZGlzcGxheU5hbWV9YCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy51cGRhdGVFbWFpbEZvcm1Db250cm9sLmRpcnR5KSB7XG4gICAgICAgICAgYXdhaXQgdXNlci51cGRhdGVFbWFpbCh0aGlzLnVwZGF0ZUVtYWlsRm9ybUNvbnRyb2wudmFsdWUpO1xuICAgICAgICAgIHNuYWNrQmFyTXNnLnB1c2goYHlvdXIgZW1haWwgaGFzIGJlZW4gdXBkYXRlZCB0byAke3VzZXIuZW1haWx9YCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy51cGRhdGVQaG9uZU51bWJlckZvcm1Db250cm9sLmRpcnR5KSB7XG4gICAgICAgICAgYXdhaXQgdXNlci51cGRhdGVQaG9uZU51bWJlcih0aGlzLnVwZGF0ZVBob25lTnVtYmVyRm9ybUNvbnRyb2wudmFsdWUpO1xuICAgICAgICAgIGNvbnNvbGUubG9nKCdwaG9uZSBudW1iZXIgPSAnLCB0aGlzLnVwZGF0ZVBob25lTnVtYmVyRm9ybUNvbnRyb2wudmFsdWUpO1xuICAgICAgICAgIHNuYWNrQmFyTXNnLnB1c2goYHlvdXIgcGhvbmUgbnVtYmVyIGhhcyBiZWVuIHVwZGF0ZWQgdG8gJHt1c2VyLnBob25lTnVtYmVyfWApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuY29uZmlnLmVuYWJsZUZpcmVzdG9yZVN5bmMpIHtcbiAgICAgICAgICBhd2FpdCB0aGlzLmZpcmVTdG9yZVNlcnZpY2UudXBkYXRlVXNlckRhdGEodGhpcy5hdXRoUHJvY2Vzcy5wYXJzZVVzZXJJbmZvKHVzZXIpKTtcbiAgICAgICAgfVxuXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICB0aGlzLmF1dGhQcm9jZXNzLnNob3dUb2FzdChlcnJvciAmJiBlcnJvci5tZXNzYWdlID8gZXJyb3IubWVzc2FnZSA6IGVycm9yKTtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICB9XG5cblxuICAgICAgaWYgKHNuYWNrQmFyTXNnLmxlbmd0aCA+IDApIHtcbiAgICAgICAgdGhpcy5hdXRoUHJvY2Vzcy5zaG93VG9hc3Qoc25hY2tCYXJNc2cuam9pbignXFxcXG4nKSk7XG4gICAgICB9XG4gICAgICAvLyB0aGlzLnVwZGF0ZUZvcm1Hcm91cC5yZXNldCgpO1xuICAgIH1cblxuICAgIHRoaXMuZWRpdE1vZGUgPSBmYWxzZTtcbiAgfVxuXG4gIHNpZ25PdXQoKSB7XG4gICAgdGhpcy5hdXRoLnNpZ25PdXQoKVxuICAgICAgLnRoZW4oKCkgPT4gdGhpcy5vblNpZ25PdXQuZW1pdCgpKVxuICAgICAgLmNhdGNoKGUgPT4gY29uc29sZS5lcnJvcignQW4gZXJyb3IgaGFwcGVuZWQgd2hpbGUgc2lnbmluZyBvdXQhJywgZSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIERlbGV0ZSB0aGUgYWNjb3VudCBvZiB0aGUgY3VycmVudCBmaXJlYmFzZSBuZ3gtYXV0aC1maXJlYmFzZXVpLXVzZXJcbiAgICpcbiAgICogT24gU3VjY2VzcywgZW1pdCB0aGUgPG9uQWNjb3VudERlbGV0ZWQ+IGV2ZW50IGFuZCB0b2FzdCBhIG1zZyEjXG4gICAqIE90aGVyd2lzZSwgbG9nIHRoZSBhbmQgdG9hc3QgYW5kIGVycm9yIG1zZyFcbiAgICpcbiAgICovXG4gIGFzeW5jIGRlbGV0ZUFjY291bnQoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHVzZXIgPSB0aGlzLmF1dGhQcm9jZXNzLnVzZXI7XG5cbiAgICAgIC8vIGF3YWl0IHRoaXMuYXV0aFByb2Nlc3MuZGVsZXRlQWNjb3VudCgpO1xuICAgICAgYXdhaXQgdGhpcy5hdXRoUHJvY2Vzcy51c2VyLmRlbGV0ZSgpO1xuICAgICAgLy8gaWYgKHRoaXMuY29uZmlnLmVuYWJsZUZpcmVzdG9yZVN5bmMpIHtcbiAgICAgIGF3YWl0IHRoaXMuZmlyZVN0b3JlU2VydmljZS5kZWxldGVVc2VyRGF0YSh1c2VyLnVpZCk7XG4gICAgICAvLyB9XG4gICAgICB0aGlzLm9uQWNjb3VudERlbGV0ZWQuZW1pdCgpO1xuICAgICAgdGhpcy5lZGl0TW9kZSA9IGZhbHNlO1xuICAgICAgY29uc29sZS5sb2coJ1lvdXIgYWNjb3VudCBoYXMgYmVlbiBzdWNjZXNzZnVsbHkgZGVsZXRlZCEnKTtcbiAgICAgIHRoaXMuYXV0aFByb2Nlc3Muc2hvd1RvYXN0KCdZb3VyIGFjY291bnQgaGFzIGJlZW4gc3VjY2Vzc2Z1bGx5IGRlbGV0ZWQhJyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdFcnJvciB3aGlsZSBkZWxldGUgdXNlciBhY2NvdW50JywgZXJyb3IpO1xuICAgICAgdGhpcy5hdXRoUHJvY2Vzcy5zaG93VG9hc3QoYEVycm9yIG9jY3VycmVkIHdoaWxlIGRlbGV0aW5nIHlvdXIgYWNjb3VudDogJHtlcnJvci5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBpbml0VXBkYXRlRm9ybUdyb3VwKCkge1xuICAgIGNvbnN0IGN1cnJlbnRVc2VyOiBVc2VyID0gdGhpcy5hdXRoUHJvY2Vzcy51c2VyO1xuICAgIHRoaXMudXBkYXRlRm9ybUdyb3VwID0gbmV3IEZvcm1Hcm91cCh7XG4gICAgICBuYW1lOiB0aGlzLnVwZGF0ZU5hbWVGb3JtQ29udHJvbCA9IG5ldyBGb3JtQ29udHJvbChcbiAgICAgICAge3ZhbHVlOiBjdXJyZW50VXNlci5kaXNwbGF5TmFtZSwgZGlzYWJsZWQ6IHRoaXMuZWRpdE1vZGV9LFxuICAgICAgICBbXG4gICAgICAgICAgVmFsaWRhdG9ycy5yZXF1aXJlZCxcbiAgICAgICAgICBWYWxpZGF0b3JzLm1pbkxlbmd0aCh0aGlzLmNvbmZpZy5uYW1lTWluTGVuZ3RoKSxcbiAgICAgICAgICBWYWxpZGF0b3JzLm1heExlbmd0aCh0aGlzLmNvbmZpZy5uYW1lTWF4TGVuZ3RoKVxuICAgICAgICBdXG4gICAgICApLFxuXG4gICAgICBlbWFpbDogdGhpcy51cGRhdGVFbWFpbEZvcm1Db250cm9sID0gbmV3IEZvcm1Db250cm9sKFxuICAgICAgICB7dmFsdWU6IGN1cnJlbnRVc2VyLmVtYWlsLCBkaXNhYmxlZDogdGhpcy5lZGl0TW9kZX0sXG4gICAgICAgIFtcbiAgICAgICAgICBWYWxpZGF0b3JzLnJlcXVpcmVkLFxuICAgICAgICAgIFZhbGlkYXRvcnMucGF0dGVybihFTUFJTF9SRUdFWClcbiAgICAgICAgXSksXG5cbiAgICAgIHBob25lTnVtYmVyOiB0aGlzLnVwZGF0ZVBob25lTnVtYmVyRm9ybUNvbnRyb2wgPSBuZXcgRm9ybUNvbnRyb2woXG4gICAgICAgIHt2YWx1ZTogY3VycmVudFVzZXIucGhvbmVOdW1iZXIsIGRpc2FibGVkOiB0aGlzLmVkaXRNb2RlfSxcbiAgICAgICAgW1ZhbGlkYXRvcnMucGF0dGVybihQSE9ORV9OVU1CRVJfUkVHRVgpXSlcbiAgICB9KTtcblxuICAgIHRoaXMudXBkYXRlRm9ybUdyb3VwLmVuYWJsZSgpO1xuICB9XG59XG4iXX0=